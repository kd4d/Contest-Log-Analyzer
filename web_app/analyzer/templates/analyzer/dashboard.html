{% extends 'base.html' %}
{% load humanize %}
{% load analyzer_extras %}
{% load static %}

{% block content %}
<style>
    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .transition {
        transition: all 0.3s ease;
    }
    .card-img-top-container {
        height: 200px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
</style>

<div class="container mt-5">
    {% include 'analyzer/partials/report_overlay.html' with overlay_breadcrumb_base="Main Dashboard" overlay_back_label="Back to Main Dashboard" %}
    {% if report_manifest_tree is not None %}
    {% include 'analyzer/partials/report_drawer.html' %}
    {% endif %}
    <script src="{% static 'js/report_overlay.js' %}"></script>
    {% if report_manifest_tree is not None %}
    <script src="{% static 'js/report_drawer.js' %}"></script>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 text-secondary">Analysis Results: <span class="text-dark">{{ full_contest_title|capitalize_iaru }}</span>
            {% if location_type %}
                <span class="badge bg-{% if location_type == 'W/VE' %}primary{% else %}success{% endif %} ms-2">
                    {{ location_type }}
                </span>
            {% endif %}
        </h2>
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>New Analysis
        </a>
    </div>
    <p class="lead text-muted mb-5">Analysis complete.
    These interactive visualizations and reports were generated directly from your uploaded logs.</p>

    <div class="mb-5">
        <h5 class="mb-4 fw-bold text-primary"><i class="bi bi-trophy me-2"></i>The Scoreboard</h5>
        <div class="row g-4">
            {% for score_data in score_reports_data %}
                {% if score_reports_data|length == 1 %}
                    <div class="col-12 col-md-8 col-lg-6 mx-auto">
                {% elif score_reports_data|length == 2 %}
                    <div class="col-12 col-md-6">
                {% else %}
                    <div class="col-12 col-md-4">
                {% endif %}
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white py-3">
                            <h6 class="mb-0 fw-bold text-primary">{{ score_data.year }} {{ score_data.contest_name|capitalize_iaru }}</h6>
                            <div class="d-flex justify-content-between align-items-baseline mt-1">
                                <span class="text-dark">{{ score_data.callsign }}</span>
                                <span class="text-primary fw-bold" style="font-size: 0.9rem;">{{ score_data.final_score|intcomma }}</span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Band</th>
                                        <th>Mode</th>
                                        <th class="text-end">QSOs</th>
                                        {% for mult_name in score_data.multiplier_names %}
                                        <th class="text-end">{{ mult_name|capitalize_iaru|abbreviate_multiplier }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in score_data.summary_data %}
                                    <tr>
                                        <td class="ps-3">{{ row|get_item:"Band" }}</td>
                                        <td>{{ row|get_item:"Mode" }}</td>
                                        <td class="text-end">{{ row|get_item:"QSOs"|intcomma }}</td>
                                        {% for mult_name in score_data.multiplier_names %}
                                        <td class="text-end">{{ row|get_item:mult_name|intcomma }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                    <tr class="table-secondary fw-bold">
                                        <td class="ps-3">{{ score_data.total_summary|get_item:"Band" }}</td>
                                        <td>{{ score_data.total_summary|get_item:"Mode" }}</td>
                                        <td class="text-end">{{ score_data.total_summary|get_item:"QSOs"|intcomma }}</td>
                                        {% for mult_name in score_data.multiplier_names %}
                                        <td class="text-end">{{ score_data.total_summary|get_item:mult_name|intcomma }}</td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer bg-light py-3">
                            <div class="d-flex flex-column gap-2">
                                {% if score_report_text_urls|get_item:score_data.callsign %}
                                <a href="{{ score_report_text_urls|get_item:score_data.callsign }}" 
                                   class="btn btn-sm btn-outline-primary report-overlay-link"
                                   title="View detailed score summary report">
                                    <i class="bi bi-file-text me-1"></i>Summary
                                </a>
                                {% endif %}
                                {% if breakdown_report_urls|get_item:score_data.callsign %}
                                <a href="{{ breakdown_report_urls|get_item:score_data.callsign }}" 
                                   class="btn btn-sm btn-outline-secondary report-overlay-link"
                                   title="View hourly QSO/multiplier breakdown">
                                    <i class="bi bi-clock-history me-1"></i>Breakdown
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body text-center py-4">
                            <p class="text-muted mb-0">No score reports available.</p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <h4 class="text-secondary fw-bold"><i class="bi bi-layers me-2"></i>Strategic Breakdown</h4>
            <hr>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 hover-shadow transition">
                <div class="card-body text-center py-5">
                    <i class="bi bi-film text-primary mb-3" style="font-size: 4rem;"></i>
                    <h5 class="card-title fw-bold">Hourly Breakdown</h5>
                    <p class="card-text text-muted small px-3">Interactive time-lapse animation.</p>
                </div>
                <div class="card-footer bg-white border-0 pb-4 text-center">
                    <a href="{% url 'view_report' session_key 'reports/'|add:report_url_path|add:'/animations/'|add:animation_file %}?source=main" class="btn btn-outline-primary stretched-link">
                        <i class="bi bi-play-circle me-1"></i>Hourly Breakdown
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 hover-shadow transition">
                <div class="card-img-top-container border-bottom">
                    <i class="bi bi-bar-chart-line text-success" style="font-size: 4rem;"></i>
                </div>
                <div class="card-body text-center py-4">
                    <h5 class="card-title fw-bold">QSO Reports</h5>
                    <p class="card-text text-muted small px-3">Rate charts and band comparisons.</p>
                </div>
                <div class="card-footer bg-white border-0 pb-4 text-center">
                     <a href="{% url 'qso_dashboard' session_key %}?source=main" class="btn btn-outline-success stretched-link">
                        <i class="bi bi-graph-up me-1"></i>QSO Reports
                    </a>
                </div>
            </div>
        </div>

        {% if show_multiplier_dashboard|default:True %}
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0 hover-shadow transition">
                <div class="card-body text-center py-5">
                    <i class="bi bi-table text-info mb-3" style="font-size: 4rem;"></i>
                    <h5 class="card-title fw-bold">Multiplier Reports</h5>
                    <p class="card-text text-muted small px-3">Missing multipliers and band-fills.</p>
                </div>
                <div class="card-footer bg-white border-0 pb-4 text-center">
                    <a href="{% url 'multiplier_dashboard' session_key %}" class="btn btn-outline-info stretched-link">
                        <i class="bi bi-list-check me-1"></i>Multiplier Reports
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row mt-5 mb-5">
        <div class="col-12 text-center">
            <div class="p-4 bg-white rounded shadow-sm border">
                <h5 class="fw-bold text-secondary mb-3">Raw Data Access</h5>
                <button id="downloadAllBtn" class="btn btn-primary btn-lg">
                    <i class="bi bi-file-earmark-zip me-2"></i>Download All Reports
                </button>
                <p class="text-muted small mt-3 mb-0">We have successfully processed your logs and generated the full suite of static reports.</p>
                
                <!-- Progress Bar Container (initially hidden) -->
                <div id="download-progress-container" class="d-none mt-4">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="1">
                            <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">1</div>
                            <div class="mt-2 small fw-bold text-muted text-uppercase">Zipping</div>
                        </div>

                        <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                            <div class="progress-seg-l step-pending"></div>
                            <div class="progress-seg-r step-pending"></div>
                        </div>

                        <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="2">
                            <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">2</div>
                            <div class="mt-2 small fw-bold text-muted text-uppercase">Downloading</div>
                        </div>

                        <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                            <div class="progress-seg-l step-pending"></div>
                            <div class="progress-seg-r step-pending"></div>
                        </div>

                        <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="3">
                            <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">3</div>
                            <div class="mt-2 small fw-bold text-muted text-uppercase">Done</div>
                        </div>
                    </div>
                    <div id="download-message" class="mt-3 text-muted small"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .progress-connector-wrapper {
        height: 10px;
        margin-top: 15px;
    }
    .progress-seg-l, .progress-seg-r {
        height: 100%;
        width: 50%;
        transition: background-color 0.4s ease;
    }
    .step-done {
        background-color: #00e676 !important;
        color: white !important;
    }
    .step-active {
        background-color: #2979ff !important;
        color: white !important;
    }
    .step-pending {
        background-color: #dee2e6 !important;
        color: #6c757d !important;
    }
    .transition-all {
        transition: all 0.4s ease;
    }
</style>

<script>
(function() {
    const downloadBtn = document.getElementById('downloadAllBtn');
    const progressContainer = document.getElementById('download-progress-container');
    const downloadMessage = document.getElementById('download-message');
    
    let pollInterval = null;
    let requestId = null;
    let downloadTriggered = false;  // Track if download has been triggered to avoid multiple downloads

    function updateDownloadProgress(step, message, fileCount, downloadUrl) {
        const steps = document.querySelectorAll('#download-progress-container .step-item');
        const wrappers = document.querySelectorAll('#download-progress-container .progress-connector-wrapper');

        steps.forEach(item => {
            const stepNum = parseInt(item.getAttribute('data-step'));
            const circle = item.querySelector('.circle');
            const label = item.querySelector('div:last-child');

            circle.classList.remove('step-pending', 'step-active', 'step-done');
            label.classList.remove('text-primary', 'text-success');

            if (stepNum < step || (stepNum === step && step === 3)) {
                // Mark as done if before current step, or if current step is 3 (Done - completion state)
                circle.classList.add('step-done');
                circle.innerHTML = '<i class="bi bi-check"></i>';
                label.classList.add('text-success');
            } else if (stepNum === step) {
                // Mark as active for steps 1 and 2
                circle.classList.add('step-active');
                circle.innerHTML = stepNum;
                label.classList.add('text-primary');
            } else {
                circle.classList.add('step-pending');
                circle.innerHTML = stepNum;
            }
        });

        // Update connectors
        wrappers.forEach((wrapper, index) => {
            const leftStepNum = index + 1;
            const rightStepNum = index + 2;
            const segL = wrapper.querySelector('.progress-seg-l');
            const segR = wrapper.querySelector('.progress-seg-r');

            segL.className = 'progress-seg-l step-pending';
            segR.className = 'progress-seg-r step-pending';

            if (step > leftStepNum) {
                segL.classList.remove('step-pending');
                segL.classList.add('step-done');
            }

            if (step > rightStepNum || (step === rightStepNum && step === 3)) {
                // Mark connector as done if step is past, or if step is 3 (Done - completion state)
                segR.classList.remove('step-pending');
                segR.classList.add('step-done');
            } else if (step === rightStepNum) {
                // Mark connector as active for steps 1 and 2
                segR.classList.remove('step-pending');
                segR.classList.add('step-active');
            }
        });

        // Update message
        if (message) {
            let msgText = message;
            if (fileCount !== undefined && fileCount !== null) {
                msgText += ` (${fileCount} files)`;
            }
            downloadMessage.textContent = msgText;
        }

        // Automatically trigger download when zip is ready (step 2) and URL is available
        if (step === 2 && downloadUrl && !downloadTriggered) {
            downloadTriggered = true;
            // Automatically start download by creating and clicking a temporary link
            const tempLink = document.createElement('a');
            tempLink.href = downloadUrl;
            tempLink.download = '';  // Let browser determine filename from Content-Disposition
            tempLink.style.display = 'none';
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
        }
    }

    function startPolling(id) {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
        
        pollInterval = setInterval(() => {
            fetch(`/analyze/progress/${id}/`)
                .then(response => response.json())
                .then(data => {
                    updateDownloadProgress(
                        data.step || 0,
                        data.message || '',
                        data.file_count,
                        data.download_url
                    );
                    if (data.step >= 3) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                })
                .catch(err => console.error('Progress polling error:', err));
        }, 500);
    }

    downloadBtn.addEventListener('click', function() {
        // Hide button, show progress
        downloadBtn.style.display = 'none';
        progressContainer.classList.remove('d-none');
        
        // Generate request_id
        requestId = 'zip_' + Math.random().toString(36).substr(2, 12);
        
        // Initialize progress
        updateDownloadProgress(1, 'Zipping...', null, null);
        
        // Start polling
        startPolling(requestId);
        
        // Get CSRF token from cookie (Django standard)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // Initiate download via POST
        const formData = new FormData();
        formData.append('request_id', requestId);
        
        fetch('{% url "download_all_reports" session_key %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to initiate download');
            }
            return response.json();
        })
        .then(data => {
            // Download started, progress will be updated via polling
        })
        .catch(err => {
            console.error('Download initiation error:', err);
            downloadMessage.textContent = 'Error: Failed to start download. Please try again.';
        });
    });
})();
</script>
{% endblock %}