{% extends 'base.html' %}
{% load static %}
{% load analyzer_extras %}

{% block content %}
<script src="{% static 'js/html2canvas.min.js' %}"></script>
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">

<style>
    /* --- Global Spacing & Typography Overrides --- */
    h4 { font-size: 1.25rem; }
    .mb-5 { margin-bottom: 1.5rem !important; } /* Tighten sections */
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <div>
            <h2 class="fw-bold text-dark mb-0">{{ report_metadata.context_line }}</h2>
            <div class="text-secondary small">{{ report_metadata.scope_line }} &bull; Multiplier Breakdown</div>
        </div>
        <a href="{% url 'dashboard_view' session_id %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back to Main Dashboard
        </a>
    </div>

    <div class="row mb-2">
        {% for log in scoreboard %}
        <div class="col-md-{{ col_width }}">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white fw-bold py-1 px-3 small">
                    {{ log.callsign }}
                </div>
                <div class="card-body text-center py-2">
                    <h4 class="mb-1">{{ log.score|default:"--" }}</h4>
                    <div class="d-flex justify-content-around text-muted" style="font-size: 0.75rem;">
                        <span>QSOs: <strong>{{ log.qsos }}</strong></span>
                        {% for k, v in log.mults.items %}
                        <span>{{ k }}: <strong>{{ v }}</strong></span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% for row in breakdown_totals %}
    {# Suppress "TOTAL" pane if there's only one multiplier type #}
    {% if row.label != "TOTAL" or multiplier_count != 1 %}
    <div class="mult-card" id="mult-summary-{{ forloop.counter }}"
         data-export-title="{{ row.label }}"
         data-export-context="{{ report_metadata.context_line }}"
         data-export-footer="{{ report_metadata.footer }}">
        <div class="mult-header">
            <div>
                <div class="d-flex align-items-baseline gap-2">
                    <h5 class="mb-0 fw-bold">{{ row.label }}</h5>
                    <span class="text-muted small" style="font-size: 0.75rem;">(Total Worked: {{ row.total_worked }})</span>
                </div>
            </div>
           
           <div class="d-flex align-items-center gap-3">
               <div class="d-flex gap-3 text-muted small">
                   <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-run);"></div>Run</div>
                   <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-sp);"></div>S&P</div>
                   <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-unk);"></div>Unknown</div>
               </div>
               
                 <button class="btn btn-sm btn-outline-secondary" onclick="captureWidget('mult-summary-{{ forloop.counter }}', 'summary_{{ row.label|slugify }}')">
                   <i class="bi bi-camera"></i>
               </button>
           </div>
        </div>
        
        <div class="horiz-grid" {% if is_sweepstakes %}style="grid-template-columns: 1fr;"{% endif %}>
            {% if not is_solo and not is_sweepstakes %}
            <div class="horiz-common">
                <div class="display-4 fw-bold text-secondary">{{ row.common }}</div>
                <div class="small fw-bold text-muted text-uppercase ls-1">Common</div>
            </div>
            {% elif is_solo and not is_sweepstakes %}
            {% for stat in row.stations %}
            {% if forloop.first %}
            <div class="horiz-common">
                <div class="display-4 fw-bold text-secondary">{{ stat.unique_run|add:stat.unique_sp|add:stat.unique_unk }}</div>
                <div class="small fw-bold text-muted text-uppercase ls-1">Total</div>
                <div class="d-flex gap-2 mt-2 justify-content-center">
                    <span class="small"><strong>{{ stat.unique_run }}</strong> Run</span>
                    <span class="small"><strong>{{ stat.unique_sp }}</strong> S&P</span>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
            
            <div class="horiz-strategy">
                <div class="horiz-strategy-content">
                    <div class="grid-lines-container">
                        <div class="v-grid-line" style="left: 0%"></div>
                        <div class="v-grid-line" style="left: 25%"></div>
                        <div class="v-grid-line" style="left: 50%"></div>
                        <div class="v-grid-line" style="left: 75%"></div>
                        {% if not is_sweepstakes or not fixed_multiplier_max %}
                        <div class="v-grid-line" style="left: 100%"></div>
                        {% endif %}
                    </div>

                    {% if is_sweepstakes and fixed_multiplier_max %}
                    {# Reference line at 100% (x=85) - positioned in same container as bars for precise alignment #}
                    <div class="h-bar-reference-line-container">
                        <div class="h-bar-reference-line"></div>
                    </div>
                    {% endif %}

                    {% for stat in row.stations %}
                {% with total_unique=stat.unique_run|add:stat.unique_sp|add:stat.unique_unk %}
                {% with scale_max=fixed_multiplier_max|default:row.max_unique %}
                {# For Sweepstakes, use stat.count (all multipliers) for both bar width AND color breakdown #}
                {# For others, use total_unique (unique only) for both bar width AND color breakdown #}
                {% if is_sweepstakes %}
                    {% with total_for_bar=stat.count %}
                    {% with total_for_colors=stat.count %}
                    <div class="h-bar-row">
                        <div class="fw-bold">{{ all_calls|get_item:forloop.counter0 }}</div>
                        <div class="h-bar-track">
                            <div class="h-bar-fill" style="width: {% widthratio total_for_bar scale_max 100 %}%;">
                                <div class="bg-run" style="width: {% widthratio stat.unique_run total_for_colors 100 %}%;"></div>
                                <div class="bg-sp" style="width: {% widthratio stat.unique_sp total_for_colors 100 %}%;"></div>
                                 <div class="bg-unk" style="width: {% widthratio stat.unique_unk total_for_colors 100 %}%;"></div>
                            </div>
                        </div>
                        <div class="fw-bold text-end">{{ stat.count }}</div>
                        <div class="fw-bold text-end text-danger">{{ stat.delta }}</div>
                    </div>
                    {% endwith %}
                    {% endwith %}
                {% else %}
                    {% with total_for_bar=total_unique %}
                    {% with total_for_colors=total_unique %}
                    <div class="h-bar-row">
                        <div class="fw-bold">{{ all_calls|get_item:forloop.counter0 }}</div>
                        <div class="h-bar-track">
                            <div class="h-bar-fill" style="width: {% widthratio total_for_bar scale_max 100 %}%;">
                                <div class="bg-run" style="width: {% widthratio stat.unique_run total_for_colors 100 %}%;"></div>
                                <div class="bg-sp" style="width: {% widthratio stat.unique_sp total_for_colors 100 %}%;"></div>
                                 <div class="bg-unk" style="width: {% widthratio stat.unique_unk total_for_colors 100 %}%;"></div>
                            </div>
                        </div>
                        <div class="fw-bold text-end">{{ stat.count }}</div>
                        <div class="fw-bold text-end text-danger">{{ stat.delta }}</div>
                    </div>
                    {% endwith %}
                    {% endwith %}
                {% endif %}
                    {% endwith %}
                    {% endwith %}
                    {% endfor %}
            
                    <div class="x-axis-row">
                        <div></div>
                        <div class="x-axis-scale" style="position: relative;">
                            {% with scale_max=fixed_multiplier_max|default:row.max_unique %}
                            <span class="tick-label" style="left: 0%">0</span>
                            <span class="tick-label" style="left: 25%">{% widthratio scale_max 4 1 %}</span>
                            <span class="tick-label" style="left: 50%">{% widthratio scale_max 2 1 %}</span>
                            <span class="tick-label" style="left: 75%">{% widthratio scale_max 4 3 %}</span>
                            <span class="tick-label" style="left: 100%; {% if is_sweepstakes and fixed_multiplier_max %}font-weight: bold; color: #000;{% endif %}">{{ scale_max }}</span>
                            {% endwith %}
                        </div>
                        <div></div><div></div>
                    </div>
                </div>
            </div>
       </div>
    </div>
    {% endif %}
    {% endfor %}

    {% if not is_sweepstakes %}
    <div class="d-flex justify-content-between align-items-center mt-5 mb-3 border-bottom pb-2">
        <h4 class="text-secondary mb-0">{% if is_mode_dimension %}Mode Spectrum{% else %}Band Spectrum{% endif %} (Unique Multipliers)</h4>
        <button class="btn btn-sm btn-outline-secondary" onclick="captureWidget('band-spectrum-container', 'band_spectrum')">
           <i class="bi bi-camera"></i>
       </button>
    </div>

    <div id="band-spectrum-container" class="bg-white p-2 rounded"
         data-export-title="{% if is_mode_dimension %}Mode Spectrum{% else %}Band Spectrum{% endif %} (Unique Multipliers)"
         data-export-context="{{ report_metadata.context_line }}"
         data-export-footer="{{ report_metadata.footer }}">
        
        <div class="d-flex justify-content-end mb-2">
            <div class="d-flex gap-3 text-muted small">
                <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-run);"></div>Run</div>
                <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-sp);"></div>S&P</div>
                <div class="d-flex align-items-center"><div class="legend-dot" style="background:var(--color-unk);"></div>Unknown</div>
            </div>
        </div>
        
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            {% if multiplier_count > 1 %}
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-all-tab" data-bs-toggle="pill" data-bs-target="#pills-all" type="button" role="tab">All Multipliers</button>
            </li>
            {% endif %}
            {% for mult_name in multiplier_names %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if multiplier_count == 1 %}active{% endif %}" id="pills-{{ mult_name|lower|replace:" : -" }}-tab" data-bs-toggle="pill" data-bs-target="#pills-{{ mult_name|lower|replace:" : -" }}" type="button" role="tab">{{ mult_name|capitalize_iaru|abbreviate_multiplier }}</button>
            </li>
            {% endfor %}
    </ul>

        <div class="tab-content" id="pills-tabContent">
            
            {% if multiplier_count > 1 %}
            <div class="tab-pane fade show active" id="pills-all" role="tabpanel">
                <div class="vert-spectrum">
                    <div class="y-axis-col">
                        <div class="y-axis-spacer-header"></div>
                        <div class="y-axis-scale-area">
                            <div class="y-tick" style="bottom: 0%">0</div>
                            <div class="y-tick" style="bottom: 25%">{% widthratio global_max.total 4 1 %}</div>
                            <div class="y-tick" style="bottom: 50%">{% widthratio global_max.total 2 1 %}</div>
                            <div class="y-tick" style="bottom: 75%">{% widthratio global_max.total 4 3 %}</div>
                             <div class="y-tick" style="bottom: 100%">{{ global_max.total }}</div>
                        </div>
                        <div class="y-axis-spacer-foundation"></div>
                        <div class="y-axis-spacer-footer"></div>
                    </div>
                 
                    <div class="h-grid-lines-container">
                        <div class="h-grid-line" style="bottom: 25%"></div>
                        <div class="h-grid-line" style="bottom: 50%"></div>
                        <div class="h-grid-line" style="bottom: 75%"></div>
                        <div class="h-grid-line" style="bottom: 100%"></div>
                    </div>

                    {% if is_mode_dimension %}
                        {% for block in low_modes_data|add:high_modes_data %}
                        <div class="vert-col">
                            <div class="vert-header">{{ block.label }}</div>
                            {% for row in block.rows %}
                               {% if row.label == "TOTAL" or row.label == block.label %}
                               <div class="vert-spikes-container">
                                    {% for stat in row.stations %}
                                    {% with total_unique=stat.unique_run|add:stat.unique_sp|add:stat.unique_unk %}
                                    <div class="vert-bar-wrapper">
                                        <div class="vert-bar" style="height: {% widthratio total_unique global_max.total 100 %}%;" data-bs-toggle="tooltip" title="{{ all_calls|get_item:forloop.counter0 }}: {{ total_unique }} Unique">
                                            <div class="bg-unk" style="height: {% widthratio stat.unique_unk total_unique 100 %}%;"></div>
                                            <div class="bg-sp" style="height: {% widthratio stat.unique_sp total_unique 100 %}%;"></div>
                                            <div class="bg-run" style="height: {% widthratio stat.unique_run total_unique 100 %}%;"></div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
               
                                {% if not is_solo and not is_sweepstakes %}
                                <div class="vert-foundation">
                                     <div class="h4 fw-bold text-secondary m-0">{{ row.common }}</div>
                                    <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Common</div>
                                </div>
                                {% elif is_solo and not is_sweepstakes %}
                                {% for stat in row.stations %}
                                {% if forloop.first %}
                                <div class="vert-foundation">
                                     <div class="h4 fw-bold text-secondary m-0">{{ stat.unique_run|add:stat.unique_sp|add:stat.unique_unk }}</div>
                                    <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Total</div>
                                    <div class="d-flex gap-1 mt-1 justify-content-center" style="font-size:0.5rem;">
                                        <span><strong>{{ stat.unique_run }}</strong>R</span>
                                        <span><strong>{{ stat.unique_sp }}</strong>S</span>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
     
                                <div class="d-flex" style="background:#f8fafc; justify-content: space-around;">
                                    {% for call in all_calls %}
                                      <div class="vert-footer" style="width: 30%;">{{ call }}</div>
                                    {% endfor %}
                                </div>
                               {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for block in low_bands_data|add:high_bands_data %}
                        <div class="vert-col">
                        <div class="vert-header">{{ block.label }}</div>
                        {% for row in block.rows %}
                           {% if row.label == "TOTAL" or row.label == block.label %}
                               <div class="vert-spikes-container">
                                    {% for stat in row.stations %}
                                    {% with total_unique=stat.unique_run|add:stat.unique_sp|add:stat.unique_unk %}
                                    <div class="vert-bar-wrapper">
                                        <div class="vert-bar" style="height: {% widthratio total_unique global_max.total 100 %}%;" data-bs-toggle="tooltip" title="{{ all_calls|get_item:forloop.counter0 }}: {{ total_unique }} Unique">
                                            <div class="bg-unk" style="height: {% widthratio stat.unique_unk total_unique 100 %}%;"></div>
                                            <div class="bg-sp" style="height: {% widthratio stat.unique_sp total_unique 100 %}%;"></div>
                                            <div class="bg-run" style="height: {% widthratio stat.unique_run total_unique 100 %}%;"></div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
               
                                {% if not is_solo and not is_sweepstakes %}
                                <div class="vert-foundation">
                                     <div class="h4 fw-bold text-secondary m-0">{{ row.common }}</div>
                                    <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Common</div>
                                </div>
                                {% elif is_solo and not is_sweepstakes %}
                                {% for stat in row.stations %}
                                {% if forloop.first %}
                                <div class="vert-foundation">
                                     <div class="h4 fw-bold text-secondary m-0">{{ stat.unique_run|add:stat.unique_sp|add:stat.unique_unk }}</div>
                                    <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Total</div>
                                    <div class="d-flex gap-1 mt-1 justify-content-center" style="font-size:0.5rem;">
                                        <span><strong>{{ stat.unique_run }}</strong>R</span>
                                        <span><strong>{{ stat.unique_sp }}</strong>S</span>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
     
                                <div class="d-flex" style="background:#f8fafc; justify-content: space-around;">
                                    {% for call in all_calls %}
                                      <div class="vert-footer" style="width: 30%;">{{ call }}</div>
                                    {% endfor %}
                                </div>
                           {% endif %}
                        {% endfor %}
                    </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% for mult_name in multiplier_names %}
            {% with mult_id=mult_name|lower|replace:" : -" mult_key=mult_name|lower|replace:" : _" %}
            {% with mult_max=global_max|get_item:mult_key %}
            <div class="tab-pane fade {% if multiplier_count == 1 %}show active{% endif %}" id="pills-{{ mult_id }}" role="tabpanel">
                <div class="vert-spectrum">
                    <div class="y-axis-col">
                        <div class="y-axis-spacer-header"></div>
                        <div class="y-axis-scale-area">
                            <div class="y-tick" style="bottom: 0%">0</div>
                            <div class="y-tick" style="bottom: 25%">{% widthratio mult_max 4 1 %}</div>
                            <div class="y-tick" style="bottom: 50%">{% widthratio mult_max 2 1 %}</div>
                            <div class="y-tick" style="bottom: 75%">{% widthratio mult_max 4 3 %}</div>
                            <div class="y-tick" style="bottom: 100%">{{ mult_max }}</div>
                        </div>
                        <div class="y-axis-spacer-foundation"></div>
                        <div class="y-axis-spacer-footer"></div>
                    </div>
 
                    <div class="h-grid-lines-container">
                        <div class="h-grid-line" style="bottom: 25%"></div>
                        <div class="h-grid-line" style="bottom: 50%"></div>
                        <div class="h-grid-line" style="bottom: 75%"></div>
                        <div class="h-grid-line" style="bottom: 100%"></div>
                    </div>

                    {% if is_mode_dimension %}
                        {% for block in low_modes_data|add:high_modes_data %}
                        <div class="vert-col">
                            <div class="vert-header">{{ block.label }}</div>
                            {% for row in block.rows %}
                                {% if mult_name in row.label %}
                                <div class="vert-spikes-container">
                                {% for stat in row.stations %}
                                {% with total_unique=stat.unique_run|add:stat.unique_sp|add:stat.unique_unk %}
                                    <div class="vert-bar-wrapper">
                                    <div class="vert-bar" style="height: {% widthratio total_unique mult_max 100 %}%;" data-bs-toggle="tooltip" title="{{ all_calls|get_item:forloop.counter0 }}: {{ total_unique }} Unique">
                                        <div class="bg-unk" style="height: {% widthratio stat.unique_unk total_unique 100 %}%;"></div>
                                        <div class="bg-sp" style="height: {% widthratio stat.unique_sp total_unique 100 %}%;"></div>
                                        <div class="bg-run" style="height: {% widthratio stat.unique_run total_unique 100 %}%;"></div>
                                    </div>
                                    </div>
                                {% endwith %}
                                {% endfor %}
                                </div>
               
                            {% if not is_solo and not is_sweepstakes %}
                            <div class="vert-foundation">
                                <div class="h4 fw-bold text-secondary m-0">{{ row.common }}</div>
                                <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Common</div>
                           </div>
                           {% elif is_solo and not is_sweepstakes %}
                           {% for stat in row.stations %}
                           {% if forloop.first %}
                           <div class="vert-foundation">
                                <div class="h4 fw-bold text-secondary m-0">{{ stat.unique_run|add:stat.unique_sp|add:stat.unique_unk }}</div>
                                <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Total</div>
                                <div class="d-flex gap-1 mt-1 justify-content-center" style="font-size:0.5rem;">
                                    <span><strong>{{ stat.unique_run }}</strong>R</span>
                                    <span><strong>{{ stat.unique_sp }}</strong>S</span>
                                </div>
                           </div>
                           {% endif %}
                           {% endfor %}
                           {% endif %}
     
                            <div class="d-flex" style="background:#f8fafc; justify-content: space-around;">
                                {% for call in all_calls %}
                                <div class="vert-footer" style="width: 30%;">{{ call }}</div>
                                {% endfor %}
                            </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for block in low_bands_data|add:high_bands_data %}
                        <div class="vert-col">
                            <div class="vert-header">{{ block.label }}</div>
                            {% for row in block.rows %}
                                {% if mult_name in row.label %}
                                <div class="vert-spikes-container">
                                {% for stat in row.stations %}
                                {% with total_unique=stat.unique_run|add:stat.unique_sp|add:stat.unique_unk %}
                                    <div class="vert-bar-wrapper">
                                    <div class="vert-bar" style="height: {% widthratio total_unique mult_max 100 %}%;" data-bs-toggle="tooltip" title="{{ all_calls|get_item:forloop.counter0 }}: {{ total_unique }} Unique">
                                        <div class="bg-unk" style="height: {% widthratio stat.unique_unk total_unique 100 %}%;"></div>
                                        <div class="bg-sp" style="height: {% widthratio stat.unique_sp total_unique 100 %}%;"></div>
                                        <div class="bg-run" style="height: {% widthratio stat.unique_run total_unique 100 %}%;"></div>
                                    </div>
                                    </div>
                                {% endwith %}
                                {% endfor %}
                                </div>
               
                            {% if not is_solo and not is_sweepstakes %}
                            <div class="vert-foundation">
                                <div class="h4 fw-bold text-secondary m-0">{{ row.common }}</div>
                                <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Common</div>
                           </div>
                           {% elif is_solo and not is_sweepstakes %}
                           {% for stat in row.stations %}
                           {% if forloop.first %}
                           <div class="vert-foundation">
                                <div class="h4 fw-bold text-secondary m-0">{{ stat.unique_run|add:stat.unique_sp|add:stat.unique_unk }}</div>
                                <div class="small fw-bold text-muted text-uppercase" style="font-size:0.6rem;">Total</div>
                                <div class="d-flex gap-1 mt-1 justify-content-center" style="font-size:0.5rem;">
                                    <span><strong>{{ stat.unique_run }}</strong>R</span>
                                    <span><strong>{{ stat.unique_sp }}</strong>S</span>
                                </div>
                           </div>
                           {% endif %}
                           {% endfor %}
                           {% endif %}
     
                            <div class="d-flex" style="background:#f8fafc; justify-content: space-around;">
                                {% for call in all_calls %}
                                <div class="vert-footer" style="width: 30%;">{{ call }}</div>
                                {% endfor %}
                            </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endwith %}
            {% endwith %}
            {% endfor %}

        </div>
    </div>
    {% endif %}
    
    <h5 class="fw-bold text-secondary mb-3 mt-5 pt-4"><i class="bi bi-file-text me-2"></i>Analysis Reports</h5>
    
    <ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="session-tab" data-bs-toggle="tab" data-bs-target="#session" type="button" role="tab" aria-controls="session" aria-selected="true">
                Missed Multipliers
            </button>
        </li>
        {% endif %}
        {% if not is_solo and all_calls|length > 2 %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pairs-tab" data-bs-toggle="tab" data-bs-target="#pairs" type="button" role="tab" aria-controls="pairs" aria-selected="false">
                Head-to-Head
            </button>
        </li>
        {% endif %}
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="singles-tab" data-bs-toggle="tab" data-bs-target="#singles" type="button" role="tab" aria-controls="singles" aria-selected="false">
                Station Detail
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="breakdown-tab" data-bs-toggle="tab" data-bs-target="#breakdown" type="button" role="tab" aria-controls="breakdown" aria-selected="false">
                Multiplier Breakdowns
            </button>
        </li>
        {% if enhanced_missed_mult_rel_path %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="enhanced-missed-tab" data-bs-toggle="tab" data-bs-target="#enhanced-missed" type="button" role="tab" aria-controls="enhanced-missed" aria-selected="false">
                Enhanced Missed Multipliers
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="analysisTabsContent">
        {% if not is_solo %}
        <div class="tab-pane fade show active" id="session" role="tabpanel" aria-labelledby="session-tab">
            <div class="reports-grid">
                    {% for mult in multipliers %}
                        {% if mult.session.missed %}
                        <div class="report-card" data-report-url="{% url 'view_report' session_id mult.session.missed %}?format=text">
                            <div class="report-header">
                                <span class="fw-bold text-danger">Missed: {{ mult.label }}</span>
                                <a href="{% url 'view_report' session_id mult.session.missed %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                            <div class="report-content">
                                <pre></pre>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                         <div class="text-muted p-3">No Missed Multiplier reports generated.</div>
                    {% endfor %}
                    {% if enhanced_missed_mult_rel_path %}
                    <div class="report-card" data-report-url="{% url 'view_report' session_id enhanced_missed_mult_rel_path %}?format=text">
                        <div class="report-header">
                            <span class="fw-bold text-primary">Enhanced Missed Multipliers</span>
                            <a href="{% url 'view_report' session_id enhanced_missed_mult_rel_path %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        <div class="report-content">
                            <pre></pre>
                        </div>
                    </div>
                    {% endif %}
            </div>
        </div>
        {% endif %}

        {% if not is_solo %}
        <div class="tab-pane fade" id="pairs" role="tabpanel" aria-labelledby="pairs-tab">
            <div class="reports-grid">
                    {% for mult in multipliers %}
                        {% for pair in mult.pairs %}
                            {% if pair.missed %}
                            <div class="report-card" data-report-url="{% url 'view_report' session_id pair.missed %}?format=text">
                                <div class="report-header">
                                    <div>
                                        <span class="d-block fw-bold text-dark small">{{ pair.label }}</span>
                                        <span class="fw-bold text-danger small">Missed {{ mult.label }}</span>
                                    </div>
                                    <a href="{% url 'view_report' session_id pair.missed %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </div>
                                <div class="report-content">
                                    <pre></pre>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if not is_solo %}
        <div class="tab-pane fade" id="singles" role="tabpanel" aria-labelledby="singles-tab">
            <div class="reports-grid">
                    {% for mult in multipliers %}
                        {% for single in mult.singles %}
                            {% if single.summary %}
                            <div class="report-card" data-report-url="{% url 'view_report' session_id single.summary %}?format=text">
                                <div class="report-header">
                                    <div>
                                        <span class="d-block fw-bold text-dark small">{{ single.label }}</span>
                                        <span class="fw-bold text-primary small">{{ mult.label }} Checklist</span>
                                    </div>
                                    <a href="{% url 'view_report' session_id single.summary %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </div>
                                <div class="report-content">
                                    <pre></pre>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="tab-pane fade {% if is_solo %}show active{% endif %}" id="breakdown" role="tabpanel" aria-labelledby="breakdown-tab">
            <div class="reports-grid">
                {% if breakdown_txt_url %}
                <div class="report-card" data-report-url="{% url 'view_report' session_id breakdown_txt_url %}?format=text">
                        <div class="report-header">
                            <span class="fw-bold text-primary">Summary Breakdown</span>
                            <a href="{% url 'view_report' session_id breakdown_txt_url %}" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="report-content">
                            <pre></pre>
                        </div>
                </div>
                {% endif %}

                {% for mult in multipliers %}
                    {% if mult.session.summary %}
                    <div class="report-card" data-report-url="{% url 'view_report' session_id mult.session.summary %}?format=text">
                            <div class="report-header">
                                <span class="fw-bold text-info">Breakdown: {{ mult.label }}</span>
                                <a href="{% url 'view_report' session_id mult.session.summary %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>
                            <div class="report-content">
                                <pre></pre>
                            </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {% if enhanced_missed_mult_rel_path %}
        <div class="tab-pane fade" id="enhanced-missed" role="tabpanel" aria-labelledby="enhanced-missed-tab">
            <div class="reports-grid">
                    <div class="report-card" data-report-url="{% url 'view_report' session_id enhanced_missed_mult_rel_path %}?format=text">
                        <div class="report-header">
                            <span class="fw-bold text-primary">Enhanced Missed Multipliers Breakdown</span>
                            <a href="{% url 'view_report' session_id enhanced_missed_mult_rel_path %}?source=mult" target="_blank" class="btn btn-sm btn-link text-muted p-0" title="Full Screen">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        <div class="report-content">
                            <pre></pre>
                        </div>
                    </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function captureWidget(elementId, filenameBase) {
        const sourceElement = document.getElementById(elementId);

        if (!sourceElement) return;

        // 1. Get Metadata from attributes
        const exportTitle = sourceElement.getAttribute('data-export-title') || 'Snapshot';
        const exportContext = sourceElement.getAttribute('data-export-context') || '';
        const exportFooter = sourceElement.getAttribute('data-export-footer') || '';

        // 2. Create Ghost Clone Container
        const ghost = document.createElement('div');
        ghost.style.position = 'absolute';
        ghost.style.left = '-9999px';
        ghost.style.top = '0';
        ghost.style.width = sourceElement.offsetWidth + 'px'; // Maintain width
        ghost.style.backgroundColor = '#ffffff';
        ghost.style.padding = '20px';
        
        // 3. Inject Header
        const headerDiv = document.createElement('div');
        headerDiv.style.borderBottom = '2px solid #3b82f6'; // Blue accent
        headerDiv.style.marginBottom = '15px';
        headerDiv.style.paddingBottom = '10px';
        headerDiv.innerHTML = `
            <h1 style="font-size: 24px; font-weight: bold; margin: 0; color: #000;">${exportTitle}</h1>
            <h3 style="font-size: 16px; margin: 5px 0 0 0; color: #666;">${exportContext}</h3>
        `;
        ghost.appendChild(headerDiv);

        // 4. Clone Content (Strip Controls)
        const clone = sourceElement.cloneNode(true);
        const buttons = clone.querySelectorAll('button');
        buttons.forEach(btn => btn.remove());
        
        // Clean styling
        clone.style.boxShadow = 'none';
        clone.style.margin = '0';
        clone.classList.remove('mult-card'); // Remove card borders if ghost wrapper handles it
        
        ghost.appendChild(clone);

        // 5. Inject Footer
        const footerDiv = document.createElement('div');
        footerDiv.style.borderTop = '1px solid #e5e7eb';
        footerDiv.style.marginTop = '15px';
        footerDiv.style.paddingTop = '10px';
        footerDiv.style.textAlign = 'center';
        footerDiv.style.fontSize = '12px';
        footerDiv.style.color = '#9ca3af';
        footerDiv.style.whiteSpace = 'pre-wrap';
        footerDiv.innerText = exportFooter;
        ghost.appendChild(footerDiv);

        document.body.appendChild(ghost);

        // 6. Capture
        html2canvas(ghost, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true
        }).then(canvas => {
            document.body.removeChild(ghost);
            
            const link = document.createElement('a');
            link.download = `${filenameBase}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }).catch(err => {
            console.error("Capture failed", err);
            document.body.removeChild(ghost);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Cache for loaded text content to avoid re-fetching
        const textContentCache = new Map();

        // Load and render text report in a card
        function loadTextReport(card) {
            const reportUrl = card.getAttribute('data-report-url');
            if (!reportUrl) return;

            // Skip if already loaded
            if (card.dataset.loaded === 'true') {
                resizeCard(card);
                return;
            }

            const preElement = card.querySelector('.report-content pre');
            if (!preElement) return;

            // Show loading state
            preElement.textContent = 'Loading...';

            // Check cache first
            if (textContentCache.has(reportUrl)) {
                renderTextContent(card, textContentCache.get(reportUrl));
                return;
            }

            // Fetch text content
            fetch(reportUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    // Cache the content
                    textContentCache.set(reportUrl, text);
                    renderTextContent(card, text);
                })
                .catch(error => {
                    console.error('[DIAG] Error loading text report:', error);
                    preElement.textContent = 'Error loading report. Please try the full screen view.';
                    // Set default width on error
                    setDefaultWidth(card);
                });
        }

        // Render text content in <pre> element
        function renderTextContent(card, text) {
            const preElement = card.querySelector('.report-content pre');
            if (!preElement) return;

            preElement.textContent = text;
            card.dataset.loaded = 'true';

            // Small delay to ensure DOM is updated, then measure and resize
            setTimeout(function() {
                resizeCard(card);
            }, 10);
        }

        // Resize card based on <pre> content width
        function resizeCard(card) {
            const preElement = card.querySelector('.report-content pre');
            if (!preElement) return;

            // Measure the natural content width
            const contentWidth = preElement.scrollWidth;
            
            // Add padding (1rem on each side = 32px total)
            const padding = 32;
            const cardWidth = Math.max(contentWidth + padding, 400); // Minimum 400px

            // Set card width
            card.style.width = cardWidth + 'px';
            card.style.minWidth = cardWidth + 'px';
            card.style.maxWidth = cardWidth + 'px';
        }

        // Set default width fallback
        function setDefaultWidth(card) {
            const defaultWidth = 600;
            card.style.width = defaultWidth + 'px';
            card.style.minWidth = defaultWidth + 'px';
            card.style.maxWidth = defaultWidth + 'px';
        }

        // Load all reports in a tab pane
        function loadReportsInPane(pane) {
            if (!pane) return;
            const cards = pane.querySelectorAll('.report-card[data-report-url]');
            cards.forEach(function(card) {
                loadTextReport(card);
            });
        }

        // Load reports when tab is shown
        function handleTabShow(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            const pane = document.querySelector(targetId);
            if (pane) {
                loadReportsInPane(pane);
            }
        }

        // Load reports in initially visible tab
        const activeTab = document.querySelector('#analysisTabs .nav-link.active');
        if (activeTab) {
            const targetId = activeTab.getAttribute('data-bs-target');
            const activePane = document.querySelector(targetId);
            if (activePane) {
                loadReportsInPane(activePane);
            }
        }

        // Listen for tab changes
        const analysisTabs = document.querySelectorAll('#analysisTabs button[data-bs-toggle="tab"]');
        analysisTabs.forEach(function(tab) {
            tab.addEventListener('shown.bs.tab', handleTabShow);
        });
    });
</script>
{% endblock %}