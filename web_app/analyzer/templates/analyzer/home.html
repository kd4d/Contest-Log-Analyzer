{% extends 'base.html' %}

{% block content %}
<style>
    .progress-connector-wrapper {
        height: 10px;
        margin-top: 15px; /* Precise offset: 20px (circle center) - 5px (bar center) */
    }
    .progress-seg-l, .progress-seg-r {
        height: 100%;
        width: 50%;
        transition: background-color 0.4s ease;
    }
    /* High Saturation Palette */
    .step-done {
        background-color: #00e676 !important;
        /* High-Vis Green */
        color: white !important;
    }
    .step-active {
        background-color: #2979ff !important;
        /* Electric Blue */
        color: white !important;
    }
    .step-pending {
        background-color: #dee2e6 !important;
        /* Contrast Grey */
        color: #6c757d !important;
        /* Muted text */
    }
    /* Tab-style buttons */
    .method-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5rem;
    }
    .method-tab {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border: none;
        background: transparent;
        color: #6c757d;
        font-weight: 600;
        cursor: pointer;
        border-radius: 0.375rem 0.375rem 0 0;
        transition: all 0.2s ease;
        position: relative;
    }
    .method-tab:hover {
        background: #f8f9fa;
        color: #495057;
    }
    .method-tab.active {
        color: #2979ff;
        background: white;
    }
    .method-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #2979ff;
    }
    .method-content {
        display: none;
    }
    .method-content.active {
        display: block;
    }
</style>
<div class="container mt-4">
    <div class="text-center mb-4">
        <h1 class="display-4 fw-bold text-primary">Contest Log Analytics</h1>
        <p class="lead text-muted">Upload your Cabrillo logs to generate detailed statistics and visualizations.</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show shadow border-start border-5 border-danger mb-4" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-3 fs-3 text-danger"></i>
                    <div>
                        <h5 class="alert-heading fw-bold"><i class="bi bi-x-circle me-2"></i>Analysis Failed</h5>
                        <div class="fs-6 text-dark">{{ error|linebreaksbr }}</div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <!-- Method Selection Tabs -->
            <div class="method-tabs">
                <button type="button" class="method-tab active" data-method="manual">
                    <i class="bi bi-upload me-2"></i>Manual Log Upload
                </button>
                <button type="button" class="method-tab" data-method="archive">
                    <i class="bi bi-cloud-download me-2"></i>Public Log Archive
                </button>
            </div>

            <!-- Main Content Container -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-body p-4">
                    
                    <!-- Manual Upload Section -->
                    <div id="manualMethod" class="method-content active">
                        <div class="alert alert-info border-0 shadow-sm mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i><strong>Upload 1, 2, or 3 Logs:</strong> Log 1 is required. Logs 2 and 3 are optional for comparison analysis.
                        </div>
                        
                        <form method="post" action="{% url 'analyze' %}" enctype="multipart/form-data" id="manualForm">
                            {% csrf_token %}
                            <input type="hidden" id="request_id" name="request_id" value="">
                            
                            <!-- Log Slots -->
                            <div class="row justify-content-center mb-4">
                                {% for field in form %}
                                    {% if field.name != 'cty_file_choice' and field.name != 'custom_cty_file' %}
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 shadow-sm border-0">
                                            <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                                <h6 class="card-title text-primary fw-bold mb-0">
                                                    <i class="bi bi-file-earmark-text me-2"></i>Log Slot {{ forloop.counter }}
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                {{ field }}
                                                {% if field.help_text %}
                                                <div class="form-text text-muted small mt-2">{{ field.help_text }}</div>
                                                {% endif %}
                                                {% for error in field.errors %}
                                                <div class="text-danger small mt-1">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- CTY File Section -->
                            <div class="border-top pt-3 mb-3">
                                <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-globe me-2"></i>CTY File (Country Data)</h6>
                                <div class="row align-items-center mb-2">
                                    <div class="col-auto">
                                        {% for choice in form.cty_file_choice %}
                                        <div class="form-check form-check-inline">
                                            {{ choice.tag }}
                                            <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                {{ choice.choice_label }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div id="ctyUploadSection" style="display: none;" class="mt-2">
                                    {{ form.custom_cty_file }}
                                    <div class="form-text text-muted small mt-2">
                                        <i class="bi bi-info-circle me-1"></i>Preferred format: <code>cty_wt_mod.dat</code>
                                    </div>
                                    {% for error in form.custom_cty_file.errors %}
                                    <div class="text-danger small mt-1">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- WRTC Scoring Rules (Advanced) -->
                            <div class="border-top pt-3 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wrtcRulesCheckbox" style="width: 1.2rem; height: 1.2rem;">
                                    <label class="form-check-label fw-bold fs-6" for="wrtcRulesCheckbox" style="font-size: 1rem !important;">
                                        <strong>Apply WRTC scoring rules</strong> <span class="text-muted">(for IARU-HF logs only)</span>
                                    </label>
                                </div>
                                <div id="wrtcSelectorContainer" class="mt-2" style="display: none;">
                                    <label class="form-label">Select WRTC contest:</label>
                                    <select class="form-select" id="wrtcContestSelector" name="contest_override">
                                        <option value="">Select WRTC contest...</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                    <div class="form-text text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Only applies to IARU-HF logs. Other contests will ignore this setting.
                                    </div>
                                </div>
                            </div>

                            <!-- Analyze Button -->
                            <div class="d-grid gap-2 col-md-4 mx-auto mt-3">
                                <button type="submit" class="btn btn-primary btn-lg shadow-sm" id="btnAnalyzeLogs" disabled>
                                    <i class="bi bi-bar-chart-fill me-2"></i>Analyze Logs
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Public Archive Section -->
                    <div id="archiveMethod" class="method-content">
                        <div class="alert alert-info border-0 shadow-sm mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i><strong>Fetch 1, 2, or 3 Logs:</strong> Log 1 is required. Logs 2 and 3 are optional for comparison analysis.<br>
                            <strong>Supported Contests:</strong> CQ World Wide DX (CW, SSB, RTTY modes), CQ 160-Meter (CW, SSB, RTTY modes), ARRL 10 Meter (no mode selection required), ARRL DX (CW and SSB - mode is determined by contest selection), ARRL IARU HF World Championship, and WRTC contests.
                        </div>
                        
                        <form id="fetchForm" method="post" action="{% url 'analyze' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" class="fetch-request-id">
                            <input type="hidden" name="fetch_callsigns" id="fetchCallsignsInput">
                            <input type="hidden" name="fetch_year" id="fetchYearInput">
                            <input type="hidden" name="fetch_mode" id="fetchModeInput">
                            <input type="hidden" name="fetch_contest" id="fetchContestInput">
                        </form>

                        <!-- Contest/Year/Mode Selection -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary">Contest</label>
                                <select class="form-select" id="archiveContest">
                                    <option value="" selected>Select Contest...</option>
                                    <option value="CQ-WW">CQ World Wide DX</option>
                                    <option value="CQ-160">CQ 160 Meter</option>
                                    <option value="ARRL-10">ARRL 10 Meter</option>
                                    <option value="ARRL-DX-CW">ARRL DX CW</option>
                                    <option value="ARRL-DX-SSB">ARRL DX SSB</option>
                                    <option value="IARU-HF">IARU HF World Championship</option>
                                    <option value="WRTC-2026">WRTC 2026</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary">Year</label>
                                <select class="form-select" id="archiveYear" disabled>
                                    <option value="" selected>Select Year...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-secondary">Mode</label>
                                <select class="form-select" id="archiveMode" disabled>
                                    <option value="" selected>Select Mode...</option>
                                    <option value="SSB">SSB</option>
                                    <option value="CW">CW</option>
                                    <option value="RTTY">RTTY</option>
                                </select>
                            </div>
                        </div>

                        <!-- Log Slots (shown after contest/year/mode selection) -->
                        <div id="archiveSlots" class="d-none">
                            <div class="row justify-content-center mb-4">
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                            <h6 class="card-title text-primary fw-bold mb-0">
                                                <i class="bi bi-file-earmark-text me-2"></i>Log Slot 1
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <input type="text" class="form-control typeahead" placeholder="Search Callsign (e.g. K3LR)..." list="callsignList1">
                                            <datalist id="callsignList1"></datalist>
                                            <div class="valid-feedback">Log Found!</div>
                                            <div class="invalid-feedback">Log not found in archive.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                            <h6 class="card-title text-primary fw-bold mb-0">
                                                <i class="bi bi-file-earmark-text me-2"></i>Log Slot 2
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <input type="text" class="form-control typeahead" placeholder="Search Callsign..." list="callsignList2">
                                            <datalist id="callsignList2"></datalist>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 shadow-sm border-0">
                                        <div class="card-header bg-white border-bottom-0 pt-3 pb-0">
                                            <h6 class="card-title text-primary fw-bold mb-0">
                                                <i class="bi bi-file-earmark-text me-2"></i>Log Slot 3
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <input type="text" class="form-control typeahead" placeholder="Search Callsign..." list="callsignList3">
                                            <datalist id="callsignList3"></datalist>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CTY File Section -->
                            <div class="border-top pt-3 mb-3">
                                <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-globe me-2"></i>CTY File (Country Data)</h6>
                                <div class="row align-items-center mb-2">
                                    <div class="col-auto">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="fetch_cty_file_choice" id="fetchCtyDefault" value="default" checked>
                                            <label class="form-check-label" for="fetchCtyDefault">
                                                Use Default CTY File
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="fetch_cty_file_choice" id="fetchCtyUpload" value="upload">
                                            <label class="form-check-label" for="fetchCtyUpload">
                                                Upload Custom CTY File
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div id="fetchCtyUploadSection" style="display: none;" class="mt-2">
                                    <input type="file" class="form-control" name="fetch_custom_cty_file" accept=".dat" id="fetchCustomCtyFile">
                                    <div class="form-text text-muted small mt-2">
                                        <i class="bi bi-info-circle me-1"></i>Preferred format: <code>cty_wt_mod.dat</code>
                                    </div>
                                </div>
                            </div>

                            <!-- WRTC Scoring Rules (Advanced) - Only for IARU-HF -->
                            <div id="fetchWrtcContainer" class="mt-3 mb-3" style="display: none;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wrtcRulesCheckboxFetch">
                                    <label class="form-check-label" for="wrtcRulesCheckboxFetch">
                                        <small>Apply WRTC scoring rules</small>
                                    </label>
                                </div>
                                <div id="wrtcSelectorContainerFetch" class="mt-2" style="display: none;">
                                    <label class="form-label small">Select WRTC contest:</label>
                                    <select class="form-select form-select-sm" id="wrtcContestSelectorFetch" name="contest_override">
                                        <option value="">Select WRTC contest...</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                    <div class="form-text small text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Only applies to IARU-HF logs. Other contests will ignore this setting.
                                    </div>
                                </div>
                            </div>

                            <!-- Fetch & Analyze Button -->
                            <div class="d-grid gap-2 col-md-4 mx-auto mt-3">
                                <button type="button" class="btn btn-success btn-lg shadow-sm" id="btnFetchAnalyze" disabled>
                                    <i class="bi bi-cloud-download-fill me-2"></i>Fetch & Analyze
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar (Shared, at bottom) -->
            <div id="progress-container" class="d-none mt-4 w-100">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="1">
                                <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">1</div>
                                <div class="mt-2 small fw-bold text-muted text-uppercase">Uploading</div>
                            </div>

                            <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                                <div class="progress-seg-l step-pending"></div>
                                <div class="progress-seg-r step-pending"></div>
                            </div>

                            <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="2">
                                <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">2</div>
                                <div class="mt-2 small fw-bold text-muted text-uppercase">Parsing</div>
                            </div>

                            <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                                <div class="progress-seg-l step-pending"></div>
                                <div class="progress-seg-r step-pending"></div>
                            </div>

                            <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="3">
                                <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">3</div>
                                <div class="mt-2 small fw-bold text-muted text-uppercase">Aggregating</div>
                            </div>

                            <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                                <div class="progress-seg-l step-pending"></div>
                                <div class="progress-seg-r step-pending"></div>
                            </div>

                            <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="4">
                                <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">4</div>
                                <div class="mt-2 small fw-bold text-muted text-uppercase">Generating</div>
                            </div>

                            <div class="progress-connector-wrapper flex-grow-1 d-flex mx-2">
                                <div class="progress-seg-l step-pending"></div>
                                <div class="progress-seg-r step-pending"></div>
                            </div>

                            <div class="d-flex flex-column align-items-center step-item" style="z-index: 1;" data-step="5">
                                <div class="rounded-circle step-pending d-flex align-items-center justify-content-center fw-bold transition-all circle" style="width: 40px; height: 40px;">5</div>
                                <div class="mt-2 small fw-bold text-muted text-uppercase">Ready</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="betaGatekeeperModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="betaLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title fw-bold" id="betaLabel">
              <i class="bi bi-cone-striped text-warning me-2"></i>Welcome to Contest Log Analytics
            </h5>
          </div>
          <div class="modal-body p-4">
             <h5 class="fw-bold text-primary mb-2"><i class="bi bi-graph-up-arrow me-2"></i>"Analytics" for Radiosport</h5>
            <p class="text-muted mb-4">
                Contest Log Analytics (CLA) is a post-mortem analysis engine designed to uncover the hidden story of your contest. By analyzing your logs against your competitors, it reveals <em>how</em> the battle was won&mdash;isolating strategic differences in Run vs. S&P rates, band changes, and multiplier hunting.
            </p>

            <div class="alert alert-warning border-0 shadow-sm d-flex align-items-start mb-4">
                <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-3 mt-1 text-warning"></i>
                <div>
                    <strong>Alpha Test Environment: Verification Required</strong><br>
                    You are accessing a pre-release version. While calculations are rigorous, the system is under active development. <strong>Please verify all insights against your raw logs before relying on them for strategic decisions.</strong>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="p-3 bg-light rounded border h-100">
                        <h6 class="fw-bold text-success"><i class="bi bi-speedometer2 me-2"></i>Full Dashboard Support</h6>
                        <p class="small text-muted mb-2">Full interactive support enabled, including the <strong>Strategy Dashboard</strong>:</p>
                        <ul class="small text-muted mb-0 ps-3">
                            <li>CQ World Wide DX (CW, SSB, RTTY)</li>
                            <li>CQ 160-Meter (CW, SSB, RTTY)</li>
                            <li>ARRL 10 Meter</li>
                            <li>ARRL DX (CW & SSB)</li>
                            <li>ARRL Sweepstakes</li>
                            <li>ARRL IARU HF World Championship</li>
                            <li>WRTC (2018, 2022, 2026)</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 bg-light rounded border h-100">
                        <h6 class="fw-bold text-secondary"><i class="bi bi-file-earmark-zip me-2"></i>ZIP Report Packages</h6>
                        <p class="small text-muted mb-2">Support limited to <strong>Downloadable Report Packages</strong> (ZIP) only:</p>
                        <ul class="small text-muted mb-0 ps-3">
                            <li>CQ WPX (CW & SSB)</li>
                            <li>ARRL Field Day</li>
                            <li>North American QSO Party (NAQP)</li>
                            <li>WAE Contest (CW & SSB)</li>
                        </ul>
                    </div>
                </div>
            </div>
          </div>
          <div class="modal-footer bg-light border-0 justify-content-center">
            <button type="button" class="btn btn-primary px-5 py-2 fw-bold" id="acceptBetaBtn">
                I Understand - Enter Alpha
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab Switching Logic
            const methodTabs = document.querySelectorAll('.method-tab');
            const methodContents = document.querySelectorAll('.method-content');
            
            methodTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    
                    // Update tab states
                    methodTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update content visibility
                    methodContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(method + 'Method').classList.add('active');
                });
            });

            // CTY File Upload Toggle (Manual Upload Form)
            const ctyRadioButtons = document.querySelectorAll('input[name="cty_file_choice"]');
            const ctyUploadSection = document.getElementById('ctyUploadSection');
            const customCtyFileInput = document.querySelector('input[name="custom_cty_file"]');
            
            if (ctyRadioButtons.length > 0 && ctyUploadSection && customCtyFileInput) {
                ctyRadioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'upload') {
                            ctyUploadSection.style.display = 'block';
                            customCtyFileInput.removeAttribute('style');
                        } else {
                            ctyUploadSection.style.display = 'none';
                            customCtyFileInput.value = '';
                        }
                    });
                });
            }

            // CTY File Upload Toggle (Public Archive Form)
            const fetchCtyRadioButtons = document.querySelectorAll('input[name="fetch_cty_file_choice"]');
            const fetchCtyUploadSection = document.getElementById('fetchCtyUploadSection');
            const fetchCustomCtyFileInput = document.getElementById('fetchCustomCtyFile');
            
            if (fetchCtyRadioButtons.length > 0 && fetchCtyUploadSection && fetchCustomCtyFileInput) {
                fetchCtyRadioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'upload') {
                            fetchCtyUploadSection.style.display = 'block';
                        } else {
                            fetchCtyUploadSection.style.display = 'none';
                            fetchCustomCtyFileInput.value = '';
                        }
                    });
                });
            }

            // Gatekeeper Logic
            if (!sessionStorage.getItem('betaAccepted')) {
                var betaModal = new bootstrap.Modal(document.getElementById('betaGatekeeperModal'));
                betaModal.show();
                document.getElementById('acceptBetaBtn').addEventListener('click', function() {
                    sessionStorage.setItem('betaAccepted', 'true');
                    betaModal.hide();
                });
            }

            // Archive UI Logic (Placeholder for CQ WW)
            const contestSelect = document.getElementById('archiveContest');
            const yearSelect = document.getElementById('archiveYear');
            const modeSelect = document.getElementById('archiveMode');
            const slotsDiv = document.getElementById('archiveSlots');
            // Populate years (2025 down to 2005)
            const currentYear = 2025;
            yearSelect.innerHTML = '<option value="" selected>Select Year...</option>';
            for (let y = currentYear; y >= 2005; y--) {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }

            // Global list of available callsigns for the selected context
            let availableCallsigns = [];
            
            // WRTC Selector for Public Archive (separate from manual upload)
            const fetchWrtcContainer = document.getElementById('fetchWrtcContainer');
            const wrtcRulesCheckboxFetch = document.getElementById('wrtcRulesCheckboxFetch');
            const wrtcSelectorContainerFetch = document.getElementById('wrtcSelectorContainerFetch');
            const wrtcContestSelectorFetch = document.getElementById('wrtcContestSelectorFetch');

            // Populate fetch WRTC selector (reuse same API)
            async function loadWRTCContestsFetch() {
                try {
                    const response = await fetch('/analyze/api/get_wrtc_contests/');
                    const data = await response.json();
                    if (data.wrtc_contests && data.wrtc_contests.length > 0) {
                        const selectOption = wrtcContestSelectorFetch.querySelector('option[value=""]');
                        wrtcContestSelectorFetch.innerHTML = '';
                        if (selectOption) {
                            wrtcContestSelectorFetch.appendChild(selectOption);
                        }
                        data.wrtc_contests.forEach(contest => {
                            const option = document.createElement('option');
                            option.value = contest;
                            option.textContent = contest;
                            wrtcContestSelectorFetch.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('[DIAG] Error loading WRTC contests for fetch form:', error);
                }
            }
            loadWRTCContestsFetch();

            // Show/hide fetch WRTC selector based on checkbox
            if (wrtcRulesCheckboxFetch) {
                wrtcRulesCheckboxFetch.addEventListener('change', function() {
                    if (this.checked) {
                        wrtcSelectorContainerFetch.style.display = 'block';
                    } else {
                        wrtcSelectorContainerFetch.style.display = 'none';
                        wrtcContestSelectorFetch.value = '';
                    }
                });
            }

            // Handle contest selection
            contestSelect.addEventListener('change', function() {
                const contest = this.value;
                
                // Show/hide WRTC container based on IARU-HF selection
                if (contest === 'IARU-HF') {
                    fetchWrtcContainer.style.display = 'block';
                } else {
                    fetchWrtcContainer.style.display = 'none';
                    // Reset WRTC selection when switching away from IARU
                    if (wrtcRulesCheckboxFetch) {
                        wrtcRulesCheckboxFetch.checked = false;
                        wrtcSelectorContainerFetch.style.display = 'none';
                        wrtcContestSelectorFetch.value = '';
                    }
                }
                
                if (contest === 'CQ-WW') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // Will be enabled after year selection
                } else if (contest === 'CQ-160') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // Will be enabled after year selection
                } else if (contest === 'ARRL-10') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // ARRL-10 has no modes
                    modeSelect.closest('.col-md-4').style.display = 'block'; // Show but disabled
                } else if (contest === 'ARRL-DX-CW' || contest === 'ARRL-DX-SSB') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // ARRL DX contests don't use mode selector
                    modeSelect.closest('.col-md-4').style.display = 'none'; // Hide mode selector entirely
                    fetchWrtcContainer.style.display = 'none'; // Hide WRTC selector
                } else if (contest === 'IARU-HF') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // IARU-HF doesn't use mode selector
                    modeSelect.closest('.col-md-4').style.display = 'none'; // Hide mode selector
                    fetchWrtcContainer.style.display = 'block'; // Show WRTC selector
                } else if (contest === 'WRTC-2026') {
                    yearSelect.disabled = false;
                    modeSelect.disabled = true; // WRTC-2026 doesn't use mode selector
                    modeSelect.closest('.col-md-4').style.display = 'none'; // Hide mode selector
                    fetchWrtcContainer.style.display = 'none'; // Hide WRTC selector (WRTC-2026 is already selected)
                    // Reset WRTC selection when switching to WRTC-2026 directly
                    if (wrtcRulesCheckboxFetch) {
                        wrtcRulesCheckboxFetch.checked = false;
                        wrtcSelectorContainerFetch.style.display = 'none';
                        wrtcContestSelectorFetch.value = '';
                    }
                } else {
                    yearSelect.disabled = true;
                    modeSelect.disabled = true;
                    slotsDiv.classList.add('d-none');
                    fetchWrtcContainer.style.display = 'none'; // Hide WRTC selector for other contests
                    // Reset WRTC selection when switching away from IARU
                    if (wrtcRulesCheckboxFetch) {
                        wrtcRulesCheckboxFetch.checked = false;
                        wrtcSelectorContainerFetch.style.display = 'none';
                        wrtcContestSelectorFetch.value = '';
                    }
                }
            });
            
            // Helper function to fetch log index (supports both CQ-WW and ARRL-10)
            function fetchLogIndex() {
                const contest = contestSelect.value;
                const year = yearSelect.value;
                const mode = modeSelect.value || ''; // May be empty for ARRL-10
                
                if (!contest || !year) {
                    return;
                }
                
                // CQ-WW and CQ-160 require mode, ARRL-10, ARRL-DX, IARU-HF, and WRTC-2026 don't
                if ((contest === 'CQ-WW' || contest === 'CQ-160') && !mode) {
                    return; // Wait for mode selection
                }
                
                // Disable inputs while loading
                const inputsToDisable = [yearSelect, modeSelect];
                inputsToDisable.forEach(inp => inp.disabled = true);
                
                // Build URL (mode may be empty for ARRL-10)
                let fetchUrl = `/analyze/api/get_log_index/?contest=${contest}&year=${year}`;
                if (mode) {
                    fetchUrl += `&mode=${mode}`;
                }
                
                fetch(fetchUrl)
                    .then(response => {
                        // Parse JSON even for error status codes to get error message
                        return response.json().then(data => {
                            if (!response.ok) {
                                // Server returned error status with JSON error message
                                throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                            }
                            return data;
                        });
                    })
                    .then(data => {
                        // Check for API errors (even if status was 200)
                        if (data.error) {
                            console.error('API Error:', data.error);
                            alert(`Failed to fetch log index: ${data.error}\n\nNote: ARRL DX public log fetch requires backend configuration.`);
                            inputsToDisable.forEach(inp => inp.disabled = false);
                            return;
                        }
                        
                        availableCallsigns = data.callsigns || [];
                        
                        if (availableCallsigns.length === 0) {
                            console.warn('No callsigns returned from API');
                            alert('No logs found for this contest/year combination.\n\nThis may indicate:\n- No logs available for this year\n- Backend configuration incomplete\n- Network/API issue');
                            inputsToDisable.forEach(inp => inp.disabled = false);
                            return;
                        }
                        
                        // Populate Datalists
                        ['callsignList1', 'callsignList2', 'callsignList3'].forEach(id => {
                             const dl = document.getElementById(id);
                            dl.innerHTML = '';
                            availableCallsigns.forEach(call => {
                                const opt = document.createElement('option');
                                opt.value = call;
                                dl.appendChild(opt);
                            });
                        });
                        
                        slotsDiv.classList.remove('d-none');
                        inputsToDisable.forEach(inp => inp.disabled = false);
                    })
                    .catch(err => {
                        console.error('Fetch Error:', err);
                        alert(`Failed to fetch log index: ${err.message}\n\nCheck browser console for details.`);
                        inputsToDisable.forEach(inp => inp.disabled = false);
                    });
            }
            
            // Handle year selection
            yearSelect.addEventListener('change', function() {
                const contest = contestSelect.value;
                if (contest === 'ARRL-10') {
                    // ARRL-10: Fetch index when year is selected (no mode needed)
                    fetchLogIndex();
                } else if (contest === 'ARRL-DX-CW' || contest === 'ARRL-DX-SSB') {
                    // ARRL DX: Fetch index when year is selected (no mode needed)
                    fetchLogIndex();
                } else if (contest === 'IARU-HF') {
                    // IARU-HF: Fetch index when year is selected (no mode needed)
                    fetchLogIndex();
                } else if (contest === 'WRTC-2026') {
                    // WRTC-2026: Fetch index when year is selected (no mode needed, uses IARU archive)
                    fetchLogIndex();
                } else if (contest === 'CQ-WW' || contest === 'CQ-160') {
                    // CQ-WW and CQ-160: Enable mode selection after year is selected
                    modeSelect.closest('.col-md-4').style.display = 'block'; // Show mode selector
                    modeSelect.disabled = false;
                }
            });
            
            // Handle mode selection (CQ-WW and CQ-160)
            modeSelect.addEventListener('change', function() {
                const contest = contestSelect.value;
                if (contest === 'CQ-WW' || contest === 'CQ-160') {
                    fetchLogIndex();
                }
            });
            // Slot Validation Logic
            const inputs = document.querySelectorAll('.typeahead');
            const btnFetch = document.getElementById('btnFetchAnalyze');
            
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const val = this.value.toUpperCase();
                    this.value = val; // Force uppercase
                    
                    if (val && availableCallsigns.includes(val)) {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    } else if (val) {
                        this.classList.add('is-invalid');
                        this.classList.remove('is-valid');
                    } else {
                        this.classList.remove('is-valid', 'is-invalid');
                    }
                    
                    // Enable button if at least one valid log is selected
                    const hasValid = Array.from(inputs).some(i => i.classList.contains('is-valid'));
                    btnFetch.disabled = !hasValid;
                });
            });
            // Handle Fetch Submission
            btnFetch.addEventListener('click', function() {
                 // Validate WRTC selection if checkbox is checked
                 if (wrtcRulesCheckboxFetch && wrtcRulesCheckboxFetch.checked) {
                     if (!wrtcContestSelectorFetch || !wrtcContestSelectorFetch.value) {
                         alert('Please select a WRTC contest from the dropdown, or uncheck "Apply WRTC scoring rules".');
                         return;
                     }
                 }
                 
                 // Disable all buttons and inputs immediately to prevent double-submission
                 disableAllFormControls();
                 
                 try {
                     const validCalls = Array.from(inputs)
                        .filter(i => i.classList.contains('is-valid'))
                        .map(i => i.value);

                     document.getElementById('fetchCallsignsInput').value = JSON.stringify(validCalls);
                     document.getElementById('fetchYearInput').value = yearSelect.value;
                     document.getElementById('fetchModeInput').value = modeSelect.value || '';
                     document.getElementById('fetchContestInput').value = contestSelect.value;
                     
                     // contest_override is already in the form as a select element, so it will submit automatically
                     
                     // Trigger Progress UI
                     const errorAlert = document.querySelector('.alert-danger');
                     if (errorAlert) {
                         errorAlert.style.display = 'none';
                     }
                    progressContainer.classList.remove('d-none');
                    requestIdInput.value = 'req_' + Math.random().toString(36).substr(2, 9);
                    document.querySelector('.fetch-request-id').value = requestIdInput.value;
                     
                    // Start polling
                    startPolling(requestIdInput.value);
                    
                    // Submit form
                    document.getElementById('fetchForm').submit();
                 } catch (error) {
                     console.error('[DIAG] Error during fetch submission:', error);
                     // Re-enable controls on error
                     enableAllFormControls();
                     alert('An error occurred while submitting the form. Please try again.');
                 }
            });

            const manualForm = document.getElementById('manualForm');
            const progressContainer = document.getElementById('progress-container');
            const requestIdInput = document.getElementById('request_id');
            // Generate UUID-like ID for this request
            const requestId = 'req_' + Math.random().toString(36).substr(2, 9);
            requestIdInput.value = requestId;
            
            // Enable/disable Analyze Logs button based on file selection
            const btnAnalyzeLogs = document.getElementById('btnAnalyzeLogs');
            const fileInputs = manualForm.querySelectorAll('input[type="file"]');
            
            function updateAnalyzeButton() {
                const hasFile = Array.from(fileInputs).some(input => input.files && input.files.length > 0);
                btnAnalyzeLogs.disabled = !hasFile;
            }
            
            fileInputs.forEach(input => {
                input.addEventListener('change', updateAnalyzeButton);
            });
            
            function startPolling(id) {
                let consecutiveErrors = 0;
                const maxErrors = 5; // Allow some transient errors
                
                const pollInterval = setInterval(() => {
                    fetch(`/analyze/progress/${id}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            consecutiveErrors = 0; // Reset error counter on success
                            updateProgress(data.step);
                            if (data.step >= 5) {
                                clearInterval(pollInterval);
                            }
                        })
                        .catch(err => {
                            consecutiveErrors++;
                            console.error('Polling error:', err);
                            
                            // If we get too many consecutive errors, assume failure and re-enable controls
                            if (consecutiveErrors >= maxErrors) {
                                clearInterval(pollInterval);
                                enableAllFormControls();
                                progressContainer.classList.add('d-none');
                                alert('Connection error during processing. Please try again.');
                            }
                        });
                }, 500);
            }

            // Helper function to disable all form controls when operation starts
            // Must be defined after all variable declarations (btnAnalyzeLogs, fileInputs, etc.)
            // CRITICAL: Do NOT disable file inputs before form submission - browsers won't include disabled file inputs in form data
            function disableAllFormControls() {
                // Disable both buttons
                btnAnalyzeLogs.disabled = true;
                btnFetch.disabled = true;
                
                // DO NOT disable file inputs here - browsers won't include disabled file inputs in form submission
                // File inputs are already "locked in" by the form, so disabling doesn't prevent double-submission anyway
                
                // Disable fetch form inputs (selects and text inputs)
                contestSelect.disabled = true;
                yearSelect.disabled = true;
                modeSelect.disabled = true;
                inputs.forEach(input => {
                    input.disabled = true;
                });
            }
            
            // Helper function to enable all form controls (for error recovery)
            function enableAllFormControls() {
                // Re-enable buttons (will be re-disabled by validation logic if needed)
                btnAnalyzeLogs.disabled = false;
                btnFetch.disabled = false;
                
                // File inputs are never disabled, so no need to re-enable them
                
                // Re-enable fetch form inputs
                // Note: These may be conditionally disabled by form logic, so we check state
                if (contestSelect.value) {
                    contestSelect.disabled = false;
                }
                if (yearSelect.value) {
                    yearSelect.disabled = false;
                }
                // Mode select is conditionally enabled based on contest/year
                if ((contestSelect.value === 'CQ-WW' || contestSelect.value === 'CQ-160') && yearSelect.value) {
                    modeSelect.closest('.col-md-4').style.display = 'block'; // Show mode selector
                    modeSelect.disabled = false;
                } else if (contestSelect.value === 'ARRL-10') {
                    modeSelect.closest('.col-md-4').style.display = 'block'; // Show but disabled
                    modeSelect.disabled = true; // ARRL-10 doesn't use mode
                } else if (contestSelect.value === 'IARU-HF' || contestSelect.value === 'WRTC-2026') {
                    modeSelect.closest('.col-md-4').style.display = 'none'; // Hide mode selector
                    modeSelect.disabled = true; // IARU-HF and WRTC-2026 don't use mode
                } else if (contestSelect.value === 'ARRL-DX-CW' || contestSelect.value === 'ARRL-DX-SSB') {
                    modeSelect.closest('.col-md-4').style.display = 'none'; // Hide mode selector
                    modeSelect.disabled = true; // ARRL-DX don't use mode
                }
                
                inputs.forEach(input => {
                    input.disabled = false;
                });
                
                // Re-validate button states
                updateAnalyzeButton();
                const hasValid = Array.from(inputs).some(i => i.classList.contains('is-valid'));
                btnFetch.disabled = !hasValid;
            }
            
            // WRTC Rules Checkbox + Selector (Simple Option 1)
            const wrtcRulesCheckbox = document.getElementById('wrtcRulesCheckbox');
            const wrtcSelectorContainer = document.getElementById('wrtcSelectorContainer');
            const wrtcContestSelector = document.getElementById('wrtcContestSelector');

            // Load available WRTC contests and populate dropdown
            async function loadWRTCContests() {
                try {
                    const response = await fetch('/analyze/api/get_wrtc_contests/');
                    const data = await response.json();
                    if (data.wrtc_contests && data.wrtc_contests.length > 0) {
                        // Clear existing options (keep the "Select..." option)
                        const selectOption = wrtcContestSelector.querySelector('option[value=""]');
                        wrtcContestSelector.innerHTML = '';
                        if (selectOption) {
                            wrtcContestSelector.appendChild(selectOption);
                        }
                        // Add WRTC options
                        data.wrtc_contests.forEach(contest => {
                            const option = document.createElement('option');
                            option.value = contest;
                            option.textContent = contest;
                            wrtcContestSelector.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('[DIAG] Error loading WRTC contests:', error);
                }
            }
            loadWRTCContests();

            // Show/hide selector based on checkbox
            if (wrtcRulesCheckbox) {
                wrtcRulesCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        wrtcSelectorContainer.style.display = 'block';
                    } else {
                        wrtcSelectorContainer.style.display = 'none';
                        wrtcContestSelector.value = ''; // Clear selection
                    }
                });
            }

            // Normal form submission
            manualForm.addEventListener('submit', function(e) {
                // Validate WRTC selection if checkbox is checked
                if (wrtcRulesCheckbox && wrtcRulesCheckbox.checked) {
                    if (!wrtcContestSelector || !wrtcContestSelector.value) {
                        alert('Please select a WRTC contest from the dropdown, or uncheck "Apply WRTC scoring rules".');
                        e.preventDefault();
                        return;
                    }
                }
                
                // Disable all buttons and inputs immediately to prevent double-submission
                disableAllFormControls();
                
                try {
                    // Show progress bar
                    const errorAlert = document.querySelector('.alert-danger');
                    if (errorAlert) {
                        errorAlert.style.display = 'none';
                    }
                    progressContainer.classList.remove('d-none');
                    
                    // Start polling
                    startPolling(requestId);
                } catch (error) {
                    console.error('[DIAG] Error during form submission:', error);
                    // Re-enable controls on error
                    enableAllFormControls();
                    progressContainer.classList.add('d-none');
                    alert('An error occurred while submitting the form. Please try again.');
                    e.preventDefault(); // Prevent form submission if we caught an error
                }
            });
            function updateProgress(currentStep) {
                const steps = document.querySelectorAll('.step-item');
                const wrappers = document.querySelectorAll('.progress-connector-wrapper');

                steps.forEach(item => {
                    const stepNum = parseInt(item.getAttribute('data-step'));
                    const circle = item.querySelector('.circle');
                    const label = item.querySelector('div:last-child');

                    // Reset classes
                    circle.classList.remove('step-pending', 'step-active', 'step-done', 'pulse-animation');
                    label.classList.remove('text-primary', 'text-success');

                    if (stepNum < currentStep) {
                        // Completed
                        circle.classList.add('step-done');
                        circle.innerHTML = '<i class="bi bi-check"></i>';
                        label.classList.add('text-success');
                    } else if (stepNum === currentStep) {
                        // Active
                        circle.classList.add('step-active');
                        circle.innerHTML = stepNum;
                        label.classList.add('text-primary');
                    } else {
                        // Pending
                        circle.classList.add('step-pending');
                        circle.innerHTML = stepNum;
                    }
                });
                // Update Connectors
                // Wrappers index 0 connects Step 1 and 2
                wrappers.forEach((wrapper, index) => {
                    const leftStepNum = index + 1;  // The step to the left
                    const rightStepNum = index + 2; // The step to the right

                    const segL = wrapper.querySelector('.progress-seg-l');
                    const segR = wrapper.querySelector('.progress-seg-r');

                    // Reset
                    segL.className = 'progress-seg-l step-pending';
                    segR.className = 'progress-seg-r step-pending';

                    // Logic:
                    // Left Segment: Green if left step is done (currentStep > leftStepNum)
                    if (currentStep > leftStepNum) {
                        segL.classList.remove('step-pending');
                        segL.classList.add('step-done');
                    }

                    // Right Segment:
                    // Blue if right step is active (currentStep == rightStepNum)
                    // Green if right step is done (currentStep > rightStepNum)
                    if (currentStep > rightStepNum) {
                        segR.classList.remove('step-pending');
                        segR.classList.add('step-done');
                    } else if (currentStep === rightStepNum) {
                        segR.classList.remove('step-pending');
                        segR.classList.add('step-active');
                    }
                });
            }
            
            // Ensure all form controls are enabled on page load if error is present
            // (This handles server-side errors that cause page reload)
            // This runs at the end, after all functions and variables are defined
            const errorAlertOnLoad = document.querySelector('.alert-danger');
            if (errorAlertOnLoad && typeof enableAllFormControls === 'function') {
                enableAllFormControls();
            }
        });
    </script>
</div>
{% endblock %}