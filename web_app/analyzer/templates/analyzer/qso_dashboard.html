{% extends 'base.html' %}
{% load static %}
{% load analyzer_extras %}

{% block content %}
<div class="container-fluid py-4">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-end">
            <a href="{% url 'dashboard_view' session_id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Main Dashboard
            </a>
        </div>
    </div>
    <style>
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
        }
        .empty-state {
            padding: 4rem 2rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        /* Hard Deck Strategy: Fixed height to prevent async thrashing */
        .viewport-frame {
            width: 100%;
            height: 900px;
            border: none;
            background-color: #fff;
            display: block;
            text-align: left;
        }
    </style>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Global Context</h5>
                    
                    {% if global_qso_rate_file %}
                    <a href="{% url 'view_report' session_id global_qso_rate_file %}?source=qso" target="_blank" class="btn btn-sm btn-light">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if global_qso_rate_file %}
                    <iframe src="{% url 'view_report' session_id global_qso_rate_file %}?chromeless=1" class="viewport-frame"></iframe>
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted" style="min-height: 200px;">
                        <div class="text-center">
                            <i class="bi bi-exclamation-circle display-4 mb-3"></i>
                            <p>Global Rate Plot Not Available</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="qsoTabs" role="tablist">
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy" type="button" role="tab">
                <i class="bi bi-chess me-2"></i>Pairwise Strategy
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cumul-tab" data-bs-toggle="tab" data-bs-target="#cumul" type="button" role="tab">
                <i class="bi bi-graph-up-arrow me-2"></i>QSOs by Band
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if is_solo %}active{% endif %}" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates" type="button" role="tab">
                <i class="bi bi-table me-2"></i>Rate Detail
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button" role="tab">
                <i class="bi bi-geo-alt me-2"></i>Points & Bands
            </button>
        </li>
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="band-activity-tab" data-bs-toggle="tab" data-bs-target="#band-activity" type="button" role="tab">
                <i class="bi bi-bar-chart-steps me-2"></i>Band Activity Comparison
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content" id="qsoTabsContent">
        {% if not is_solo %}
        <div class="tab-pane fade show active" id="strategy" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="strategySelect"><i class="bi bi-people me-2"></i>Select Matchup:</label>
                <select class="form-select" id="strategySelect">
                {% for m in matchups %}
                    <option value="{{ forloop.counter }}"
                        data-breakdown-json="{{ m.qso_breakdown_json }}"
                        data-breakdown-full="{% url 'view_report' session_id m.qso_breakdown_file %}?source=qso"
                        {% for band, path in m.diff_paths.items %}
                        data-diff-json-{{ band }}="{{ m.diff_json_paths|get_item:band }}"
                        data-diff-full-{{ band }}="{% url 'view_report' session_id path %}?source=qso"
                        {% endfor %}
                    >{{ m.label }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Strategy Breakdown (Uniques)</span>
                            <a id="link-breakdown" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-breakdown" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="me-2">Rate Differential</span>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="160">160</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="80">80</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="40">40</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="20">20</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="15">15</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn" data-band="10">10</button>
                                    <button type="button" class="btn btn-outline-secondary diff-band-btn active" data-band="all">All</button>
                                </div>
                            </div>
                            <a id="link-diff" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-diff" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="tab-pane fade" id="cumul" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="cumulSelect"><i class="bi bi-filter me-2"></i>Select Band:</label>
                <select class="form-select" id="cumulSelect">
                {% for p in qso_band_plots %}
                    <option value="{{ p.label }}"
                            data-json-src="{{ p.file_json }}"
                            data-full-src="{% url 'view_report' session_id p.file_html %}?source=qso"
                            {% if p.active %}selected{% endif %}>{{ p.label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Cumulative QSO Rates (By Band)</span>
                            <a id="link-qso-rates" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-qso-rates" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if is_solo %}show active{% endif %}" id="rates" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="ratesSelect"><i class="bi bi-journal-text me-2"></i>Select Log:</label>
                <select class="form-select" id="ratesSelect">
                {% if rate_sheet_comparison %}
                    <option value="comparison" selected
                            data-src="{% url 'view_report' session_id rate_sheet_comparison %}?chromeless=1"
                            data-full-src="{% url 'view_report' session_id rate_sheet_comparison %}?source=qso">Comparison (All Logs)</option>
                {% endif %}
                {% for call in callsigns %}
                    <option value="{{ call }}"
                            data-src="{% url 'view_report' session_id report_base|add:'/text/rate_sheet_'|add:call|add:'.txt' %}?chromeless=1"
                            data-full-src="{% url 'view_report' session_id report_base|add:'/text/rate_sheet_'|add:call|add:'.txt' %}?source=qso"
                            {% if is_solo and forloop.first %}selected{% endif %}>{{ call }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Rate Detail</span>
                    <a id="link-rates" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                </div>
                <div class="card-body p-0">
                    <iframe id="frame-rates" src="" class="viewport-frame"></iframe>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="points" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="pointsSelect"><i class="bi bi-filter me-2"></i>Select Band:</label>
                <select class="form-select" id="pointsSelect">
                {% for p in point_plots %}
                    <option value="{{ p.label }}"
                            data-json-src="{{ p.file_json }}"
                            data-full-src="{% url 'view_report' session_id p.file_html %}?source=qso"
                            {% if p.active %}selected{% endif %}>{{ p.label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Cumulative Points</span>
                            <a id="link-points" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-points" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if not is_solo %}
        <div class="tab-pane fade" id="band-activity" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="bandActivitySelect"><i class="bi bi-people me-2"></i>Select Matchup:</label>
                <select class="form-select" id="bandActivitySelect">
                {% for m in matchups %}
                    {% if m.band_activity_json %}
                        <option value="{{ m.id }}"
                                data-json-src="{{ m.band_activity_json }}"
                                data-full-src="{% url 'view_report' session_id m.band_activity_file %}?source=qso">
                            {{ m.label }}
                        </option>
                    {% else %}
                        <option value="{{ m.id }}" disabled>
                            {{ m.label }} (Not Available)
                        </option>
                    {% endif %}
                {% endfor %}
                </select>
            </div>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Band Activity Butterfly Chart</span>
                    <a id="link-band-activity" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                </div>
                <div class="card-body p-0">
                    <div id="chart-band-activity-wrapper" class="viewport-frame" style="overflow-y: auto; overflow-x: hidden; min-width: 100%; display: block;">
                        <div id="chart-band-activity" style="height: 100%; width: 100%; min-width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Strategy Tab Logic ---
        
        const strategySelect = document.getElementById('strategySelect');
        const chartBreakdownId = 'chart-breakdown';
        const chartDiffId = 'chart-diff';
        const linkBreakdown = document.getElementById('link-breakdown');
        const linkDiff = document.getElementById('link-diff');
        const diffBandBtns = document.querySelectorAll('.diff-band-btn');
        let currentDiffBand = 'all';

        // Generic Chart Renderer
        function renderChart(containerId, jsonUrl) {
            
            const container = document.getElementById(containerId);
            if (!container) return;

            // --- DIAGNOSTIC HELPER (FLIGHT RECORDER) ---
            const logHierarchy = (stage) => {
                if (containerId !== 'chart-band-activity') return;
                console.group(`[CLA-DIAG] ${stage} | Timestamp: ${performance.now().toFixed(1)}ms`);
                
                let el = container;
                let depth = 0;
                while (el && el.tagName !== 'BODY' && depth < 15) {
                    const rect = el.getBoundingClientRect();
                    const style = window.getComputedStyle(el);
                    console.log(
                        `%c${" ".repeat(depth)}<${el.tagName} id="${el.id}" class="${el.className}">`, 
                        'color: blue; font-weight: bold;',
                        `\n    Width: ${rect.width.toFixed(2)}px | CSS Width: ${style.width} | Min-Width: ${style.minWidth} | Display: ${style.display} | Overflow: ${style.overflow}`
                    );
                    el = el.parentElement;
                    depth++;
                }
                console.groupEnd();
            };
            // -------------------------------------------

            // --- BEACON: SEND LOGS TO DOCKER CONSOLE ---
            const sendBeacon = (stage, payload) => {
                if (containerId !== 'chart-band-activity') return;
                let beaconUrl = '';
                if (payload) {
                     // Generic Payload Mode
                     beaconUrl = `/DIAGNOSTIC_BEACON/${stage}/${payload}`;
                } else {
                     // Standard Dimensions Mode
                     const rect = container.getBoundingClientRect();
                     const width = Math.round(rect.width);
                     const styleWidth = window.getComputedStyle(container).width.replace('px','');
                     beaconUrl = `/DIAGNOSTIC_BEACON/STAGE_${stage}/WIDTH_${width}/STYLE_${styleWidth}`;
                }
                
                // Fire and forget
                fetch(beaconUrl, {method: 'GET', keepalive: true}).catch(() => {});
            };
            // -------------------------------------------
            
            logHierarchy("ENTRY");
            sendBeacon("ENTRY");

            // --- LAZY LOADING: Defer render if container is hidden ---
            if (container.offsetParent === null) {
                container.dataset.pendingSrc = jsonUrl;
                logHierarchy("DEFER (Hidden)");
                sendBeacon("DEFER_HIDDEN");
                return;
            }
            delete container.dataset.pendingSrc;
            // Clear previous if no URL
            if (!jsonUrl) {
                container.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">No Data</div>';
                return;
            }

            fetch(jsonUrl)
                .then(response => response.json())
                .then(data => {
                    requestAnimationFrame(() => {
                        logHierarchy("PRE-PLOT (Inside RAF)");
                        sendBeacon("PRE_PLOT");
                        
                        Plotly.purge(containerId);

                        const layout = data.layout || {};

                        // --- RATIO-PRESERVING SCALER (Plan 1.0.26) ---
                        // 1. Establish Reference Geometry (From JSON)
                        // If JSON lacks dimensions, assume a standard 4:3 ratio (1200x900) as fallback.
                        const refW = layout.width || 1200;
                        const refH = layout.height || 900;
                        
                        // 2. Measure Reality (DOM)
                        // This is the hard constraint provided by the browser layout.
                        const rect = container.getBoundingClientRect();
                        const availW = rect.width > 0 ? rect.width : 1100; // Safety floor

                        // 3. Calculate Scale & Derived Height
                        // New Height = Reference Height * (Available Width / Reference Width)
                        const scaleFactor = availW / refW;
                        const targetH = Math.round(refH * scaleFactor);

                        // 4. Enforce CSS Height
                        // We must resize the container explicitly to match the plot's new shape.
                        container.style.height = targetH + 'px';

                        // 5. Overwrite Layout Config (The Command)
                        layout.width = availW;
                        layout.height = targetH;
                        layout.autosize = false; // Disable Plotly's internal guessing

                        // 6. Sanitize Margins
                        if (!layout.margin) layout.margin = {};
                        layout.margin.b = 150; 
                        layout.margin.autoexpand = true;

                        // 7. Log the Scaling Operation
                        const logMsg = `REF_${refW}x${refH}_TO_${Math.round(availW)}x${targetH}_SCALE_${scaleFactor.toFixed(2)}`;
                        sendBeacon("SCALING_APPLIED", logMsg);

                        Plotly.newPlot(containerId, data.data, layout, {responsive: false, displayModeBar: false}).then(() => {
                            logHierarchy("POST-PLOT (Success)");
                            sendBeacon("POST_PLOT_SUCCESS");
                            
                            const observer = new ResizeObserver(entries => {
                                for (let entry of entries) {
                                    if (containerId === 'chart-band-activity') {
                                        const newW = entry.contentRect.width;
                                        
                                        // Only relayout if significant change to prevent jitter
                                        if (Math.abs(newW - layout.width) > 5) {
                                            // Recalculate Height based on the fixed Aspect Ratio
                                            const newH = Math.round(refH * (newW / refW));
                                            
                                            console.log(`[CLA-DIAG] Scaling from ${layout.width}x${layout.height} to ${newW}x${newH}`);
                                            
                                            // Update Container & Plot
                                            container.style.height = newH + 'px';
                                            layout.width = newW;
                                            layout.height = newH;
                                            
                                            Plotly.relayout(containerId, { width: newW, height: newH });
                                            sendBeacon("RESIZE_EVENT", `RESCALED_TO_${Math.round(newW)}x${newH}`);
                                        }
                                    } else {
                                        // Standard behavior for other charts
                                        Plotly.Plots.resize(containerId);
                                    }
                                }
                            });
                            observer.observe(container);
                        });
                    });
                })
                .catch(err => {
                    console.error("Chart render error:", err);
                    container.innerHTML = '<div class="alert alert-danger m-3">Error loading chart</div>';
                });
        }

        function updateStrategy() {
            if(!strategySelect) return;
            const selectedOption = strategySelect.options[strategySelect.selectedIndex];
            
            // Render Breakdown Chart
            renderChart(chartBreakdownId, selectedOption.dataset.breakdownJson);
            linkBreakdown.href = selectedOption.dataset.breakdownFull;
            
            updateDiffContent();
        }
        
        function updateDiffContent() {
            if (!strategySelect) return;
            const selectedOption = strategySelect.options[strategySelect.selectedIndex];
            
            // Get JSON URL
            let diffJson = selectedOption.getAttribute('data-diff-json-' + currentDiffBand);
            if (!diffJson) diffJson = selectedOption.getAttribute('data-diff-json-all');
            
            // Get Full Link
            let diffFull = selectedOption.getAttribute('data-diff-full-' + currentDiffBand);
            if (!diffFull) diffFull = selectedOption.getAttribute('data-diff-full-all');

            renderChart(chartDiffId, diffJson);
            if(linkDiff && diffFull) linkDiff.href = diffFull;
        }

        if(strategySelect) {
            updateStrategy();
            // Init
            strategySelect.addEventListener('change', updateStrategy);
        }
        
        diffBandBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                diffBandBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDiffBand = btn.dataset.band;
                
                updateDiffContent();
            });
        });

        // --- Generic Dropdown Logic for other tabs ---
        // Enhanced: Supports both iframe (src) and Div/Plotly (json-src)
        function setupDropdown(selectId, targetId, linkId) {
            const select = document.getElementById(selectId);
            const target = document.getElementById(targetId);
            const link = document.getElementById(linkId);
            
            if (!select || !target) return;

            function update() {
                const opt = select.options[select.selectedIndex];
                if (target.tagName === 'IFRAME') {
                    // Iframe Mode (Legacy text reports)
                    target.src = opt.dataset.src;
                } else {
                    // Div Mode (New JSON Charts)
                    renderChart(targetId, opt.dataset.jsonSrc);
                }
                
                if(link) link.href = opt.dataset.fullSrc;
            }
            
            update();
            // Init
            select.addEventListener('change', update);
        }

        setupDropdown('cumulSelect', 'chart-qso-rates', 'link-qso-rates');
        // Changed to chart ID
        setupDropdown('ratesSelect', 'frame-rates', 'link-rates');
        // Remains Iframe
        setupDropdown('pointsSelect', 'chart-points', 'link-points');

        // --- Band Activity: Explicit "Lazy Click-to-Load" Architecture ---
        // This replaces generic setupDropdown to prevent race conditions with Plotly layout.
        const bandSelect = document.getElementById('bandActivitySelect');
        const bandContainer = document.getElementById('chart-band-activity');
        const bandLink = document.getElementById('link-band-activity');
        let bandChartInitialized = false;

        function updateBandActivity() {
            if (!bandSelect) return;
            const opt = bandSelect.options[bandSelect.selectedIndex];
            const jsonUrl = opt.dataset.jsonSrc;
            const fullUrl = opt.dataset.fullSrc;

            if (bandLink) bandLink.href = fullUrl;

            // Strategy: Visibility-Gated Proxy
            // If visible: Render immediately.
            // If hidden: Stash in 'data-manual-src' (Hidden from generic loader).
            if (bandContainer.offsetParent !== null) {
                renderChart('chart-band-activity', jsonUrl);
                bandChartInitialized = true;
                delete bandContainer.dataset.manualSrc; 
            } else {
                bandContainer.dataset.manualSrc = jsonUrl;
            }
        }

        // 1. Bind Dropdown (State Change)
        if (bandSelect) {
            bandSelect.addEventListener('change', updateBandActivity);
            // Initial State: Execute logic to update Link and Stash URL (Safe: Visibility check prevents render)
            updateBandActivity();
        }

        // 2. Bind Tab Show (The Trigger)
        const bandTab = document.getElementById('band-activity-tab');
        if (bandTab) {
            bandTab.addEventListener('shown.bs.tab', function(e) {
                // CRITICAL: RequestAnimationFrame ensures DOM paint is complete before Plotly measures.
                requestAnimationFrame(() => {
                    const stashed = bandContainer.dataset.manualSrc;
                    
                    if (stashed) {
                         // Lazy Load: First View or Dirty State
                         renderChart('chart-band-activity', stashed);
                         bandChartInitialized = true;
                         delete bandContainer.dataset.manualSrc;
                    } else if (bandChartInitialized) {
                        // Re-Entry: Just resize to fix layout
                        Plotly.Plots.resize(bandContainer);
                    }
                });
            });
        }

        // --- Tab Resize Fix ---
        // Force Plotly to recalculate width when a tab becomes visible
        var tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach(function(tabEl) {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                var targetId = event.target.getAttribute('data-bs-target');
                var targetPane = document.querySelector(targetId);
                
                // 1. Initialize Pending Charts (Lazy Load)
                var pending = targetPane.querySelectorAll('[data-pending-src]');
                pending.forEach(function(el) {
                    renderChart(el.id, el.dataset.pendingSrc);
                });

                // Find all Plotly charts in this pane
                var charts = targetPane.querySelectorAll('.js-plotly-plot');
                charts.forEach(function(chart) {
                    Plotly.Plots.resize(chart);
                });
            });
        });
    });
</script>
{% endblock %}