{% extends 'base.html' %}
{% load static %}
{% load analyzer_extras %}

{% block content %}
<div class="container-fluid py-4">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-end">
            <a href="{% url 'dashboard_view' session_id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Main Dashboard
            </a>
        </div>
    </div>
    <style>
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
        }
        .empty-state {
            padding: 4rem 2rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        /* Hard Deck Strategy: Fixed height to prevent async thrashing */
        .viewport-frame {
            width: 100%;
            height: 900px;
            border: none;
            background-color: #fff;
            display: block;
            text-align: left;
        }
        /* Subplot charts need more vertical space for multi-line titles */
        .viewport-frame-subplot {
            height: 1500px; /* Increased height for subplot charts with 3-line titles and legend */
        }
    </style>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Global Context</h5>
                    
                    {% if global_qso_rate_file %}
                    <a href="{% url 'view_report' session_id global_qso_rate_file %}?source=qso" target="_blank" class="btn btn-sm btn-light">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if global_qso_rate_file %}
                    <iframe src="{% url 'view_report' session_id global_qso_rate_file %}?chromeless=1" class="viewport-frame"></iframe>
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted" style="min-height: 200px;">
                        <div class="text-center">
                            <i class="bi bi-exclamation-circle display-4 mb-3"></i>
                            <p>Global Rate Plot Not Available</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="qsoTabs" role="tablist">
        {% if is_contest_wide_qso and not is_solo %}
        {# Contest-wide QSO counting: Show Contest Total and Band Distribution tabs #}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="contest-total-tab" data-bs-toggle="tab" data-bs-target="#contest-total" type="button" role="tab">
                <i class="bi bi-pie-chart me-2"></i>Contest Total
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="band-distribution-tab" data-bs-toggle="tab" data-bs-target="#band-distribution" type="button" role="tab">
                <i class="bi bi-bar-chart me-2"></i>Band Distribution
            </button>
        </li>
        {% else %}
        {# Standard per-band QSO counting: Show existing tabs #}
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy" type="button" role="tab">
                <i class="bi bi-chess me-2"></i>Pairwise Strategy
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cumul-tab" data-bs-toggle="tab" data-bs-target="#cumul" type="button" role="tab">
                <i class="bi bi-graph-up-arrow me-2"></i>{{ qso_tab_label }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if is_solo %}active{% endif %}" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates" type="button" role="tab">
                <i class="bi bi-table me-2"></i>Rate Detail
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button" role="tab">
                <i class="bi bi-geo-alt me-2"></i>{{ points_tab_label }}
            </button>
        </li>
        {% if not is_solo %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="band-activity-tab" data-bs-toggle="tab" data-bs-target="#band-activity" type="button" role="tab">
                <i class="bi bi-bar-chart-steps me-2"></i>{{ activity_tab_label }} Comparison
            </button>
        </li>
        {% endif %}
        {% endif %}
    </ul>

    <div class="tab-content" id="qsoTabsContent">
        {% if is_contest_wide_qso and not is_solo %}
        {# Contest-wide QSO counting: Contest Total tab #}
        <div class="tab-pane fade show active" id="contest-total" role="tabpanel">
            {% if contest_wide_qso_report %}
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>QSO Breakdown - Contest Total</span>
                            <a href="{% url 'view_report' session_id contest_wide_qso_report %}?source=qso" target="_blank" class="btn btn-xs btn-link text-muted">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        <div class="card-body p-0">
                            <iframe src="{% url 'view_report' session_id contest_wide_qso_report %}?chromeless=1" class="viewport-frame"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>Contest-wide QSO breakdown report not available.
            </div>
            {% endif %}
        </div>

        {# Contest-wide QSO counting: Band Distribution tab #}
        <div class="tab-pane fade" id="band-distribution" role="tabpanel">
            {% if band_distribution_json %}
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>QSO Band Distribution</span>
                            <a href="{% url 'view_report' session_id band_distribution_report %}?source=qso" target="_blank" class="btn btn-xs btn-link text-muted">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                        <div class="card-body p-0">
                            {# Direct Plotly embedding for autosize charts - avoids iframe constraints #}
                            <div id="chart-band-distribution" style="width: 100%; min-height: 1200px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>Band distribution report not available.
            </div>
            {% endif %}
        </div>
        {% else %}
        {# Standard per-band QSO counting: Existing tabs #}
        {% if not is_solo %}
        <div class="tab-pane fade show active" id="strategy" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="strategySelect"><i class="bi bi-people me-2"></i>Select Matchup:</label>
                <select class="form-select" id="strategySelect">
                {% for m in matchups %}
                    <option value="{{ forloop.counter }}"
                        data-breakdown-json="{{ m.qso_breakdown_json }}"
                        data-breakdown-full="{% url 'view_report' session_id m.qso_breakdown_file %}?source=qso"
                        {% for key, path in m.diff_paths.items %}
                        data-diff-json-{{ key }}="{{ m.diff_json_paths|get_item:key }}"
                        data-diff-full-{{ key }}="{% url 'view_report' session_id path %}?source=qso"
                        {% endfor %}
                    >{{ m.label }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Strategy Breakdown (Uniques)</span>
                            <a id="link-breakdown" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-breakdown" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="me-2">Rate Differential</span>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if diff_selector_type == 'mode' %}
                                        {# Mode selector for single-band, multi-mode contests (e.g., ARRL 10) #}
                                        {% for mode in valid_modes %}
                                        <button type="button" class="btn btn-outline-secondary diff-selector-btn {% if mode.key == 'all' %}active{% endif %}" data-dimension="mode" data-value="{{ mode.key }}">{{ mode.display }}</button>
                                        {% endfor %}
                                    {% else %}
                                        {# Band selector for multi-band contests (default) #}
                                        {% for band in valid_bands %}
                                        <button type="button" class="btn btn-outline-secondary diff-selector-btn" data-dimension="band" data-value="{{ band.key }}">{{ band.display }}</button>
                                        {% endfor %}
                                        <button type="button" class="btn btn-outline-secondary diff-selector-btn active" data-dimension="band" data-value="all">All</button>
                                    {% endif %}
                                </div>
                            </div>
                            <a id="link-diff" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-diff" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="tab-pane fade" id="cumul" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="cumulSelect"><i class="bi bi-filter me-2"></i>Select {{ dimension_label }}:</label>
                <select class="form-select" id="cumulSelect">
                {% for p in qso_band_plots %}
                    <option value="{{ p.label }}"
                            data-json-src="{{ p.file_json }}"
                            data-full-src="{% url 'view_report' session_id p.file_html %}?source=qso"
                            {% if p.active %}selected{% endif %}>{{ p.label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Cumulative QSO Rates (By {{ dimension_label }})</span>
                            <a id="link-qso-rates" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-qso-rates" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade {% if is_solo %}show active{% endif %}" id="rates" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="ratesSelect"><i class="bi bi-journal-text me-2"></i>Select Log:</label>
                <select class="form-select" id="ratesSelect">
                {% if rate_sheet_comparison %}
                    <option value="comparison" selected
                            data-src="{% url 'view_report' session_id rate_sheet_comparison %}?chromeless=1"
                            data-full-src="{% url 'view_report' session_id rate_sheet_comparison %}?source=qso">Comparison (All Logs)</option>
                {% endif %}
                {% for call in callsigns %}
                    <option value="{{ call }}"
                            data-src="{% url 'view_report' session_id report_base|add:'/text/rate_sheet_'|add:call|add:'.txt' %}?chromeless=1"
                            data-full-src="{% url 'view_report' session_id report_base|add:'/text/rate_sheet_'|add:call|add:'.txt' %}?source=qso"
                            {% if is_solo and forloop.first %}selected{% endif %}>{{ call }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Rate Detail</span>
                    <a id="link-rates" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                </div>
                <div class="card-body p-0">
                    <iframe id="frame-rates" src="" class="viewport-frame"></iframe>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="points" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="pointsSelect"><i class="bi bi-filter me-2"></i>Select {{ dimension_label }}:</label>
                <select class="form-select" id="pointsSelect">
                {% for p in point_plots %}
                    <option value="{{ p.label }}"
                            data-json-src="{{ p.file_json }}"
                            data-full-src="{% url 'view_report' session_id p.file_html %}?source=qso"
                            {% if p.active %}selected{% endif %}>{{ p.label }}</option>
                {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Cumulative Points</span>
                            <a id="link-points" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <div class="card-body p-0">
                            <div id="chart-points" class="viewport-frame" style="overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if not is_solo and not is_contest_wide_qso %}
        <div class="tab-pane fade" id="band-activity" role="tabpanel">
            <div class="input-group mb-3 w-auto">
                <label class="input-group-text" for="bandActivitySelect"><i class="bi bi-people me-2"></i>Select Matchup:</label>
                <select class="form-select" id="bandActivitySelect">
                {% for m in matchups %}
                    {% if m.band_activity_json %}
                        <option value="{{ m.id }}"
                                data-json-src="{{ m.band_activity_json }}"
                                data-full-src="{% url 'view_report' session_id m.band_activity_file %}?source=qso">
                            {{ m.label }}
                        </option>
                    {% else %}
                        <option value="{{ m.id }}" disabled>
                            {{ m.label }} (Not Available)
                        </option>
                    {% endif %}
                {% endfor %}
                </select>
            </div>
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>{{ activity_tab_title }}</span>
                    <a id="link-band-activity" href="#" target="_blank" class="btn btn-xs btn-link text-muted"><i class="bi bi-box-arrow-up-right"></i></a>
                </div>
                <div class="card-body p-0">
                    <div id="chart-band-activity-wrapper" class="viewport-frame" style="overflow-y: auto; overflow-x: hidden; display: block;">
                        <div id="chart-band-activity"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Strategy Tab Logic ---
        
        const strategySelect = document.getElementById('strategySelect');
        const chartBreakdownId = 'chart-breakdown';
        const chartDiffId = 'chart-diff';
        const linkBreakdown = document.getElementById('link-breakdown');
        const linkDiff = document.getElementById('link-diff');
        const diffSelectorBtns = document.querySelectorAll('.diff-selector-btn');
        // Initialize currentDiffKey based on selector type and default active button
        let currentDiffKey = 'band:all';  // Default to band:all, will be updated by active button
        // Set initial key from active button if present
        const activeBtn = document.querySelector('.diff-selector-btn.active');
        if (activeBtn) {
            const dimension = activeBtn.dataset.dimension;
            const value = activeBtn.dataset.value;
            currentDiffKey = `${dimension}:${value}`;
        }

        // Generic Chart Renderer
        function renderChart(containerId, jsonUrl) {
            
            const container = document.getElementById(containerId);
            if (!container) return;

            // --- DIAGNOSTIC HELPER (FLIGHT RECORDER) ---
            const logHierarchy = (stage) => {
                if (containerId !== 'chart-band-activity') return;
                console.group(`[CLA-DIAG] ${stage} | Timestamp: ${performance.now().toFixed(1)}ms`);
                
                let el = container;
                let depth = 0;
                while (el && el.tagName !== 'BODY' && depth < 15) {
                    const rect = el.getBoundingClientRect();
                    const style = window.getComputedStyle(el);
                    console.log(
                        `%c${" ".repeat(depth)}<${el.tagName} id="${el.id}" class="${el.className}">`, 
                        'color: blue; font-weight: bold;',
                        `\n    Width: ${rect.width.toFixed(2)}px | CSS Width: ${style.width} | Min-Width: ${style.minWidth} | Display: ${style.display} | Overflow: ${style.overflow}`
                    );
                    el = el.parentElement;
                    depth++;
                }
                console.groupEnd();
            };
            // -------------------------------------------
            
            logHierarchy("ENTRY");

            // --- LAZY LOADING: Defer render if container is hidden ---
            if (container.offsetParent === null) {
                container.dataset.pendingSrc = jsonUrl;
                logHierarchy("DEFER (Hidden)");
                return;
            }
            delete container.dataset.pendingSrc;
            // Clear previous if no URL
            if (!jsonUrl) {
                container.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">No Data</div>';
                return;
            }

            fetch(jsonUrl)
                .then(response => response.json())
                .then(data => {
                    requestAnimationFrame(() => {
                        logHierarchy("PRE-PLOT (Inside RAF)");
                        
                        Plotly.purge(containerId);

                        const layout = data.layout || {};

                        // --- BUTTERFLY CHART: Fixed-Size Rendering ---
                        if (containerId === 'chart-band-activity') {
                            const wrapper = container.parentElement;
                            
                            console.log('[BUTTERFLY] === INITIALIZATION START ===');
                            console.log('[BUTTERFLY] JSON Layout width:', layout.width, 'height:', layout.height);
                            
                            // Get the exact dimensions from Python-generated JSON
                            const chartWidth = layout.width || 1200;
                            const chartHeight = layout.height || 1350;
                            
                            // CRITICAL: Do NOT modify layout.width or layout.height
                            // Plotly's subplot domains are calculated for these exact dimensions
                            // Any change breaks the positioning
                            
                            // Set container to exact chart dimensions (no negotiation)
                            container.style.width = chartWidth + 'px';
                            container.style.height = chartHeight + 'px';
                            container.style.minWidth = '0';  // Allow shrinking if needed
                            
                            // Set wrapper to provide scrolling viewport
                            wrapper.style.width = '100%';  // Fill available width
                            wrapper.style.maxWidth = chartWidth + 'px';  // But don't exceed chart width
                            wrapper.style.height = '900px';  // Fixed viewport height
                            wrapper.style.overflow = 'auto';  // Enable scrollbars
                            
                            console.log('[BUTTERFLY] Fixed chart size:', chartWidth, 'x', chartHeight);
                            console.log('[BUTTERFLY] Wrapper: max-width=' + chartWidth + 'px, height=900px, overflow=auto');
                            
                            // Render at exact JSON dimensions
                            Plotly.newPlot(containerId, data.data, layout, {
                                responsive: false, 
                                displayModeBar: false
                            }).then(() => {
                                logHierarchy("POST-PLOT (Success - Butterfly)");
                                
                                const finalRect = container.getBoundingClientRect();
                                console.log('[BUTTERFLY] === RENDER COMPLETE ===');
                                console.log('[BUTTERFLY] Rendered at:', finalRect.width, 'x', finalRect.height);
                                console.log('[BUTTERFLY] Match expected:', finalRect.width === chartWidth && finalRect.height === chartHeight ? 'YES' : 'NO');
                            }).catch(err => {
                                console.error("Butterfly chart render error:", err);
                                container.innerHTML = '<div class="alert alert-danger m-3">Error loading butterfly chart</div>';
                            });
                            
                            return; // Exit early - no responsive logic for butterfly charts
                        }

                        // --- RATIO-PRESERVING SCALER (Plan 1.0.26) ---
                        // 1. Establish Reference Geometry (From JSON)
                        // If JSON lacks dimensions, assume a standard 4:3 ratio (1200x900) as fallback.
                        const refW = layout.width || 1200;
                        const refH = layout.height || 900;
                        
                        // 2. Measure Reality (DOM)
                        // This is the hard constraint provided by the browser layout.
                        const rect = container.getBoundingClientRect();
                        const availW = rect.width > 0 ? rect.width : 1100; // Safety floor

                        // 3. Calculate Scale & Derived Height
                        // New Height = Reference Height * (Available Width / Reference Width)
                        const scaleFactor = availW / refW;
                        const targetH = Math.round(refH * scaleFactor);

                        // 4. Enforce CSS Height
                        // We must resize the container explicitly to match the plot's new shape.
                        container.style.height = targetH + 'px';

                        // 5. Overwrite Layout Config (The Command)
                        layout.width = availW;
                        layout.height = targetH;
                        layout.autosize = false; // Disable Plotly's internal guessing

                        // 6. Sanitize Margins
                        if (!layout.margin) layout.margin = {};
                        layout.margin.b = 150; 
                        layout.margin.autoexpand = true;

                        Plotly.newPlot(containerId, data.data, layout, {responsive: false, displayModeBar: false}).then(() => {
                            logHierarchy("POST-PLOT (Success)");
                            
                            const observer = new ResizeObserver(entries => {
                                // Note: Butterfly chart (chart-band-activity) has its own ResizeObserver above
                                // Standard behavior for all other charts
                                for (let entry of entries) {
                                    Plotly.Plots.resize(containerId);
                                }
                            });
                            observer.observe(container);
                        });
                    });
                })
                .catch(err => {
                    console.error("Chart render error:", err);
                    container.innerHTML = '<div class="alert alert-danger m-3">Error loading chart</div>';
                });
        }

        function updateStrategy() {
            if(!strategySelect) return;
            const selectedOption = strategySelect.options[strategySelect.selectedIndex];
            
            // Render Breakdown Chart
            renderChart(chartBreakdownId, selectedOption.dataset.breakdownJson);
            linkBreakdown.href = selectedOption.dataset.breakdownFull;
            
            updateDiffContent();
        }
        
        function updateDiffContent() {
            if (!strategySelect) return;
            const selectedOption = strategySelect.options[strategySelect.selectedIndex];
            
            // Get JSON URL using structured key format (dimension:value)
            // Try exact match first, then fallback to "all"
            let diffJson = selectedOption.getAttribute('data-diff-json-' + currentDiffKey);
            if (!diffJson) {
                // Fallback: try "all" variant
                const dimension = currentDiffKey.split(':')[0];
                const fallbackKey = dimension + ':all';
                diffJson = selectedOption.getAttribute('data-diff-json-' + fallbackKey);
            }
            
            // Get Full Link using structured key format
            let diffFull = selectedOption.getAttribute('data-diff-full-' + currentDiffKey);
            if (!diffFull) {
                // Fallback: try "all" variant
                const dimension = currentDiffKey.split(':')[0];
                const fallbackKey = dimension + ':all';
                diffFull = selectedOption.getAttribute('data-diff-full-' + fallbackKey);
            }

            renderChart(chartDiffId, diffJson);
            if(linkDiff && diffFull) linkDiff.href = diffFull;
        }

        if(strategySelect) {
            updateStrategy();
            // Init
            strategySelect.addEventListener('change', updateStrategy);
        }
        
        diffSelectorBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                diffSelectorBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // Build structured key: "dimension:value" (e.g., "band:all", "mode:cw")
                const dimension = btn.dataset.dimension;
                const value = btn.dataset.value;
                currentDiffKey = `${dimension}:${value}`;
                
                updateDiffContent();
            });
        });

        // --- Generic Dropdown Logic for other tabs ---
        // Enhanced: Supports both iframe (src) and Div/Plotly (json-src)
        function setupDropdown(selectId, targetId, linkId) {
            const select = document.getElementById(selectId);
            const target = document.getElementById(targetId);
            const link = document.getElementById(linkId);
            
            if (!select || !target) return;

            function update() {
                const opt = select.options[select.selectedIndex];
                if (target.tagName === 'IFRAME') {
                    // Iframe Mode (Legacy text reports)
                    target.src = opt.dataset.src;
                } else {
                    // Div Mode (New JSON Charts)
                    renderChart(targetId, opt.dataset.jsonSrc);
                }
                
                if(link) link.href = opt.dataset.fullSrc;
            }
            
            update();
            // Init
            select.addEventListener('change', update);
        }

        setupDropdown('cumulSelect', 'chart-qso-rates', 'link-qso-rates');
        // Changed to chart ID
        setupDropdown('ratesSelect', 'frame-rates', 'link-rates');
        // Remains Iframe
        setupDropdown('pointsSelect', 'chart-points', 'link-points');

        // --- Band Distribution Chart: Direct Plotly Embedding (for autosize charts) ---
        {% if band_distribution_json %}
        (function() {
            const containerId = 'chart-band-distribution';
            const container = document.getElementById(containerId);
            const jsonUrl = '{{ band_distribution_json }}';
            
            if (container && jsonUrl) {
                // Load and render chart when tab becomes visible
                const bandDistTab = document.getElementById('band-distribution-tab');
                if (bandDistTab) {
                    bandDistTab.addEventListener('shown.bs.tab', function() {
                        if (!container.dataset.loaded) {
                            container.dataset.loaded = 'true';
                            renderChart(containerId, jsonUrl);
                        }
                    });
                    // Also load if tab is already active
                    if (bandDistTab.classList.contains('active')) {
                        container.dataset.loaded = 'true';
                        renderChart(containerId, jsonUrl);
                    }
                }
            }
        })();
        {% endif %}

        // --- Band Activity: Explicit "Lazy Click-to-Load" Architecture ---
        // This replaces generic setupDropdown to prevent race conditions with Plotly layout.
        const bandSelect = document.getElementById('bandActivitySelect');
        const bandContainer = document.getElementById('chart-band-activity');
        const bandLink = document.getElementById('link-band-activity');
        let bandChartInitialized = false;

        function updateBandActivity() {
            if (!bandSelect) return;
            const opt = bandSelect.options[bandSelect.selectedIndex];
            const jsonUrl = opt.dataset.jsonSrc;
            const fullUrl = opt.dataset.fullSrc;

            if (bandLink) bandLink.href = fullUrl;

            // Strategy: Visibility-Gated Proxy
            // If visible: Render immediately.
            // If hidden: Stash in 'data-manual-src' (Hidden from generic loader).
            if (bandContainer.offsetParent !== null) {
                renderChart('chart-band-activity', jsonUrl);
                bandChartInitialized = true;
                delete bandContainer.dataset.manualSrc; 
            } else {
                bandContainer.dataset.manualSrc = jsonUrl;
            }
        }

        // 1. Bind Dropdown (State Change)
        if (bandSelect) {
            bandSelect.addEventListener('change', updateBandActivity);
            // Initial State: Execute logic to update Link and Stash URL (Safe: Visibility check prevents render)
            updateBandActivity();
        }

        // 2. Bind Tab Show (The Trigger)
        const bandTab = document.getElementById('band-activity-tab');
        if (bandTab) {
            bandTab.addEventListener('shown.bs.tab', function(e) {
                // CRITICAL: RequestAnimationFrame ensures DOM paint is complete before Plotly measures.
                requestAnimationFrame(() => {
                    const stashed = bandContainer.dataset.manualSrc;
                    
                    if (stashed) {
                         // Lazy Load: First View or Dirty State
                         renderChart('chart-band-activity', stashed);
                         bandChartInitialized = true;
                         delete bandContainer.dataset.manualSrc;
                    } else if (bandChartInitialized) {
                        // Re-Entry: Just resize to fix layout
                        Plotly.Plots.resize(bandContainer);
                    }
                });
            });
        }

        // --- Tab Resize Fix ---
        // Force Plotly to recalculate width when a tab becomes visible
        var tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach(function(tabEl) {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                var targetId = event.target.getAttribute('data-bs-target');
                var targetPane = document.querySelector(targetId);
                
                // 1. Initialize Pending Charts (Lazy Load)
                var pending = targetPane.querySelectorAll('[data-pending-src]');
                pending.forEach(function(el) {
                    renderChart(el.id, el.dataset.pendingSrc);
                });

                // Find all Plotly charts in this pane
                var charts = targetPane.querySelectorAll('.js-plotly-plot');
                charts.forEach(function(chart) {
                    Plotly.Plots.resize(chart);
                });
            });
        });
    });
</script>
{% endblock %}